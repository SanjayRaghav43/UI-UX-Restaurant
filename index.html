<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GourmetVerse 3D - Ultimate Dining</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Poppins:wght@300;400;600&family=Bangers&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

    <!-- Three.js & Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Correct GLTFLoader Import -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- Shared Cart Module -->
    <script src="shared-cart.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: 'Poppins', sans-serif; background-color: #0d0604; color: white; -webkit-font-smoothing: antialiased; user-select: none; }
        
        /* Brown Void Background */
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; 
            background: radial-gradient(circle at 50% 50%, #3e2723 0%, #1a0f0d 60%, #000000 100%); 
        }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .interactive { pointer-events: auto; }
        
        /* Premium Glassmorphism */
        .glass {
            background: rgba(30, 20, 15, 0.9);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 200, 150, 0.15);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
        }
        
        .font-heading { font-family: 'Playfair Display', serif; }
        .font-tech { font-family: 'Orbitron', sans-serif; }
        .font-comic { font-family: 'Bangers', cursive; letter-spacing: 2px; -webkit-text-stroke: 1px black; }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #8d6e63; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a1887f; }

        .hidden-section { display: none; opacity: 0; }
        
        /* Animations */
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.2); } 100% { transform: scale(1); opacity: 1; } }
        .animate-pop { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        /* Loader */
        #loader { position: fixed; inset: 0; background: #0a0503; z-index: 100; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .spinner { width: 60px; height: 60px; border: 4px solid #3e2723; border-top-color: #d7ccc8; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Eating Animation Overlay */
        #eating-overlay { pointer-events: none; }
        .super-text { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); 
            z-index: 65; color: #ffecb3; font-size: 4rem; text-shadow: 4px 4px 0px #3e2723;
            pointer-events: none; white-space: nowrap; font-weight: bold;
            transition: all 0.2s;
            text-align: center;
            width: 100%;
        }

        /* Menu Card */
        .menu-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform: translateZ(0); }
        .menu-card:hover { transform: translateY(-8px); border-color: #a1887f; background: rgba(255,255,255,0.08); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); }
        
        /* Drag & Drop */
        .draggable-item { cursor: grab; user-select: none; }
        .draggable-item:active { cursor: grabbing; }
        .drop-target-active { background: rgba(255, 255, 255, 0.05); border: 2px dashed #a1887f; }
        .bin-active { transform: scale(1.2) rotate(15deg); color: #ef4444; border-color: #ef4444 !important; box-shadow: 0 0 20px rgba(239, 68, 68, 0.5); background-color: rgba(239, 68, 68, 0.2); }
        
        /* Drag Ghost for 3D items */
        #drag-ghost { position: absolute; pointer-events: none; width: 80px; height: 80px; border-radius: 50%; background-size: cover; background-position: center; z-index: 1000; opacity: 0.9; transform: translate(-50%, -50%); display: none; box-shadow: 0 10px 20px rgba(0,0,0,0.5); border: 3px solid white; background-color: #3e2723; }
        
        /* 3D Item Labels */
        .item-label { 
            position: absolute; 
            background: rgba(251, 191, 36, 0.9); 
            color: black; 
            padding: 4px 8px; 
            border-radius: 12px; 
            font-size: 14px; 
            font-weight: bold;
            pointer-events: none; 
            transform: translate(-50%, -100%); 
            border: 2px solid white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            white-space: nowrap;
        }

        /* Touch friendly buttons */
        .touch-btn { transition: transform 0.1s; }
        .touch-btn:active { transform: scale(0.95); }

        /* PROFESSIONAL SUCCESS ANIMATION */
        .checkmark-wrapper { width: 100px; height: 100px; position: relative; margin: 0 auto; }
        .checkmark__circle { stroke-dasharray: 166; stroke-dashoffset: 166; stroke-width: 2; stroke-miterlimit: 10; stroke: #22c55e; fill: none; animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards; }
        .checkmark__check { transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48; animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards; }
        .checkmark { width: 100px; height: 100px; border-radius: 50%; display: block; stroke-width: 2; stroke: #fff; stroke-miterlimit: 10; margin: 0 auto; box-shadow: inset 0px 0px 0px #22c55e; animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both; }
        
        @keyframes stroke { 100% { stroke-dashoffset: 0; } }
        @keyframes scale { 0%, 100% { transform: none; } 50% { transform: scale3d(1.1, 1.1, 1); } }
        @keyframes fill { 100% { box-shadow: inset 0px 0px 0px 50px #22c55e; } }

        /* Star Rating */
        .star-rating span { font-size: 2.5rem; cursor: pointer; color: #444; transition: color 0.2s; }
        .star-rating span.active { color: #ffd700; text-shadow: 0 0 10px #b45309; }
        
        /* Memory Game Cards - BIGGER */
        .memory-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 10px; height: 100%; align-content: center; }
        .memory-card { perspective: 1000px; width: 100%; aspect-ratio: 1/1; position: relative; cursor: pointer; }
        .memory-inner { width: 100%; height: 100%; position: absolute; transition: transform 0.6s; transform-style: preserve-3d; }
        .memory-card.flipped .memory-inner { transform: rotateY(180deg); }
        .memory-front, .memory-back { width: 100%; height: 100%; position: absolute; backface-visibility: hidden; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 3rem; box-shadow: 0 4px 8px rgba(0,0,0,0.5); }
        .memory-front { background: linear-gradient(135deg, #5d4037, #3e2723); color: #d7ccc8; transform: rotateY(0deg); border: 2px solid #a1887f; font-weight: bold; }
        .memory-back { background: #1a0f0d; color: white; transform: rotateY(180deg); border: 2px solid #fbbf24; }
        
        /* Sudoku */
        .sudoku-cell { width: 32px; height: 32px; text-align: center; background: transparent; border: 1px solid #5d4037; color: #d7ccc8; font-family: monospace; font-size: 14px; }
        .sudoku-cell:focus { background: #3e2723; outline: none; border-color: #a1887f; }

        /* Game Over Overlay */
        .game-over-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20; opacity: 0; pointer-events: none; transition: opacity 0.5s; backdrop-filter: blur(5px); }
        .game-over-overlay.visible { opacity: 1; pointer-events: auto; }

        /* Whack Hole */
        .whack-hole { position: relative; overflow: hidden; border-radius: 50%; background: #2a1810; box-shadow: inset 0 10px 10px rgba(0,0,0,0.5); }
        .whack-mole { position: absolute; bottom: -100%; left: 10%; width: 80%; height: 80%; transition: bottom 0.1s; font-size: 40px; display: flex; justify-content: center; align-items: center; user-select: none; }
        .whack-mole.up { bottom: 0; }
        .bonk-anim { animation: bonk 0.2s ease-in-out; }
        @keyframes bonk { 0% { transform: scale(1); } 50% { transform: scale(1.3) rotate(10deg); } 100% { transform: scale(0); opacity: 0; } }

        /* Timer/Status Animation */
        @keyframes scan-line { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }
        .scan-animation { position: absolute; left: 0; width: 100%; height: 2px; background: #4ade80; box-shadow: 0 0 10px #4ade80; animation: scan-line 2s linear infinite; }
        .status-glow { animation: glow 2s infinite alternate; }
        @keyframes glow { from { box-shadow: 0 0 10px #eab308; } to { box-shadow: 0 0 30px #eab308; } }

        /* Payment Icons Grid */
        .payment-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .pay-icon { background: #fff; padding: 5px; border-radius: 8px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s; }
        .pay-icon:hover { transform: scale(1.05); }
        .pay-icon img { max-height: 100%; max-width: 100%; }

        /* KDS Styles */
        .kds-col { background: #1a0f0d; border: 1px solid #3e2723; border-radius: 12px; padding: 1rem; display: flex; flex-direction: column; gap: 1rem; height: 100%; }
        .kds-header { font-family: 'Orbitron', sans-serif; border-bottom: 1px solid #5d4037; padding-bottom: 0.5rem; margin-bottom: 0.5rem; font-weight: bold; letter-spacing: 1px; }
        .kds-card { background: #2c1b18; padding: 1rem; border-radius: 8px; border-left: 4px solid #eab308; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .kds-card.ready { border-left-color: #22c55e; }
        .kds-card.pending { border-left-color: #ef4444; }

    </style>
</head>
<body>

    <!-- Drag Ghost Element -->
    <div id="drag-ghost"></div>
    
    <!-- Item Labels Container -->
    <div id="labels-container" class="absolute top-0 left-0 w-full h-full pointer-events-none overflow-hidden z-10"></div>

    <!-- Notification Toast -->
    <div id="notification-toast" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-full shadow-2xl z-[100] hidden flex items-center gap-3 transition-all duration-500 translate-y-[-100px]">
        <span class="text-xl">üçΩÔ∏è</span>
        <span id="toast-msg" class="font-bold">Order Ready!</span>
    </div>

    <!-- Loader -->
    <div id="loader">
        <div class="flex flex-col items-center gap-6">
            <div class="spinner"></div>
            <div class="text-center">
                <p class="text-[#d7ccc8] font-heading text-xl tracking-[0.2em] mb-1">GOURMET<span class="text-yellow-600">VERSE</span></p>
                <p class="text-gray-500 text-xs tracking-widest">PREPARING KITCHEN...</p>
            </div>
        </div>
    </div>

    <!-- Eating Animation Text -->
    <div id="eating-overlay">
        <div id="super-text" class="super-text font-comic">DELICIOUS!</div>
    </div>

    <!-- 3D Scene -->
    <div id="canvas-container"></div>

    <!-- UI Layer -->
    <div id="ui-layer" class="flex flex-col h-full justify-between p-4 md:p-6 pointer-events-none">
        
        <!-- Header -->
        <header class="flex justify-between items-center interactive select-none z-50 pointer-events-auto">
            <div class="flex items-center gap-4 cursor-pointer group" onclick="app.switchView('home')">
                <div class="w-12 h-12 bg-gradient-to-br from-[#5d4037] to-[#3e2723] rounded-full flex items-center justify-center font-bold text-[#efebe9] border border-[#a1887f] shadow-lg group-hover:scale-105 transition">GV</div>
                <div class="hidden sm:block">
                    <h1 class="text-2xl font-heading text-[#efebe9] font-bold tracking-wider leading-none">GOURMET</h1>
                    <span class="text-[10px] text-[#a1887f] tracking-[0.4em] uppercase font-bold">Verse</span>
                </div>
            </div>
            
            <nav class="hidden md:flex gap-2 lg:gap-3 bg-black/60 backdrop-blur-md px-3 lg:px-6 py-3 rounded-full border border-white/10 shadow-2xl">
                <button onclick="app.switchView('home')" class="hover:text-yellow-500 transition text-gray-300 text-[10px] lg:text-xs font-bold tracking-widest uppercase">Home</button>
                <button onclick="app.switchView('menu')" class="hover:text-yellow-500 transition text-gray-300 text-[10px] lg:text-xs font-bold tracking-widest uppercase">Menu</button>
                <button onclick="window.location.href='c3.html'" class="text-yellow-500 hover:text-yellow-400 transition text-[10px] lg:text-xs font-bold tracking-widest uppercase flex items-center gap-1 lg:gap-2"><span class="text-lg">‚ú®</span> Builder</button>
              <button onclick="window.location.href='games1.html'" class="hover:text-yellow-500 transition text-gray-300 text-[10px] lg:text-xs font-bold tracking-widest uppercase">Fun Zone</button>
                <button onclick="app.switchView('kitchen')" class="hover:text-yellow-500 transition text-red-400 text-[10px] lg:text-xs font-bold tracking-widest uppercase">Kitchen</button>
            </nav>

            <div class="flex gap-4">
                <button onclick="app.openFeedbackModal(true)" class="bg-gradient-to-r from-purple-700 to-indigo-700 hover:from-purple-600 hover:to-indigo-600 text-white px-3 lg:px-5 py-2 rounded-full text-xs font-bold border border-purple-500 transition shadow-lg flex items-center gap-2 touch-btn">
                    üí¨ <span class="hidden lg:inline">Feedback</span>
                </button>
                <button onclick="app.toggleCart()" class="relative bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-500 hover:to-orange-500 text-white px-4 lg:px-6 py-2 rounded-full font-bold transition shadow-lg flex items-center gap-3 group border border-yellow-800 touch-btn">
                    <span>Cart</span>
                    <span id="cart-count" class="bg-white text-black text-xs font-bold px-2 py-0.5 rounded-full shadow-inner">0</span>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 flex items-center justify-center relative w-full h-full pointer-events-none">
            
            <!-- HOME VIEW -->
            <div id="view-home" class="text-center max-w-5xl pointer-events-auto select-none mt-10 md:mt-0 z-40">
                <h2 class="text-6xl md:text-9xl font-heading font-bold mb-4 text-[#efebe9] drop-shadow-[0_10px_30px_rgba(0,0,0,0.9)] opacity-90 leading-tight">
                    Taste <span class="text-transparent bg-clip-text bg-gradient-to-r from-[#d7ccc8] to-[#a1887f]">Essence</span>
                </h2>
                <p class="text-gray-400 text-sm md:text-lg mb-10 max-w-2xl mx-auto font-light">
                    Experience the 14-inch Touch UI. Drag, drop, and dine in Augmented Reality.
                </p>
                <div class="flex flex-col md:flex-row gap-6 justify-center mb-8">
                    <button onclick="window.location.href='c3.html'" class="group relative px-10 py-5 bg-gradient-to-r from-amber-600 to-orange-600 text-white font-bold rounded-xl overflow-hidden shadow-[0_0_30px_rgba(245,158,11,0.3)] hover:scale-105 transition duration-300 touch-btn z-50 pointer-events-auto">
                        <span class="relative z-10 flex items-center gap-2 text-lg">VR PLATE BUILDER <span class="group-hover:translate-x-1 transition">üëåüíñ</span></span>
                    </button>
                    <button onclick="app.switchView('menu')" class="px-10 py-5 border border-white/20 bg-white/5 backdrop-blur rounded-xl hover:bg-white/10 transition text-white flex items-center gap-2 touch-btn z-50 pointer-events-auto font-bold text-lg">
                         MENU
                    </button>
                </div>
                <!-- Track Order Button -->
                <button onclick="app.trackOrder()" class="px-8 py-3 bg-gradient-to-r from-blue-900 to-blue-800 border border-blue-600 rounded-full text-white font-bold text-sm tracking-widest hover:scale-105 transition shadow-lg pointer-events-auto touch-btn">
                    TRACK ACTIVE ORDER
                </button>
            </div>

            <!-- MENU OVERLAY -->
            <div id="view-menu" class="hidden-section glass w-full max-w-7xl h-[85vh] rounded-[2rem] p-6 md:p-10 overflow-hidden flex flex-col pointer-events-auto border-t border-[#a1887f]/20 shadow-2xl">
                <div class="flex justify-between items-end mb-6 border-b border-[#a1887f]/20 pb-4 flex-shrink-0">
                    <div>
                        <h3 class="text-4xl font-heading text-[#efebe9]">Signature Menu</h3>
                        <p class="text-[#a1887f] mt-1 text-sm font-light">Select items to view grams & nutrition</p>
                    </div>
                    <div class="flex gap-2">
                         <button onclick="app.filterMenu('veg')" class="px-6 py-2 bg-gradient-to-r from-green-800 to-green-700 border border-green-600 rounded-lg text-xs font-bold text-white hover:bg-green-600 transition">Veg</button>
                         <button onclick="app.filterMenu('non-veg')" class="px-6 py-2 bg-gradient-to-r from-red-800 to-red-700 border border-red-600 rounded-lg text-xs font-bold text-white hover:bg-red-600 transition">Non-Veg</button>
                         <button onclick="app.filterMenu('all')" class="px-6 py-2 bg-gradient-to-r from-gray-800 to-gray-700 border border-gray-600 rounded-lg text-xs font-bold text-white hover:bg-gray-600 transition">All</button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto pr-2 pb-4 scroll-smooth">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="menu-grid">
                        <!-- Items injected by JS -->
                    </div>
                </div>
            </div>

            <!-- PLATE BUILDER (VR) -->
            <div id="view-builder" class="hidden-section w-full h-full pointer-events-auto flex flex-col md:flex-row absolute inset-0 pt-24 pb-4 px-4">
                <!-- Sidebar - Tablet Optimized Grid -->
                <div class="w-full md:w-[450px] h-full glass rounded-3xl p-6 flex flex-col overflow-hidden border border-[#a1887f]/20 z-20 shadow-2xl mb-4 md:mb-0 md:mr-4">
                    <h3 class="text-2xl font-heading text-[#efebe9] mb-2">Plate Builder</h3>
                    <p class="text-xs text-yellow-500 mb-4 font-bold animate-pulse">Drag items or Tap + to add</p>
                    
                    <div class="flex gap-1 mb-4 justify-between">
                        <button onclick="app.filterBuilder('veg')" class="px-2 py-1 bg-green-900/50 border border-green-700 rounded text-[10px] font-bold hover:bg-green-800 flex-1 transition">Veg</button>
                        <button onclick="app.filterBuilder('non-veg')" class="px-2 py-1 bg-red-900/50 border border-red-700 rounded text-[10px] font-bold hover:bg-red-800 flex-1 transition">Non-Veg</button>
                        <button onclick="app.filterBuilder('all')" class="px-2 py-1 bg-gray-800 border border-gray-600 rounded text-[10px] font-bold hover:bg-gray-700 flex-1 transition">All</button>
                    </div>

                    <div class="flex-1 overflow-y-auto pr-1 grid grid-cols-1 sm:grid-cols-2 gap-3 content-start" id="builder-items">
                        <!-- Items injected here -->
                    </div>

                    <div class="mt-4 border-t-2 border-[#a1887f]/40 pt-4 bg-black/60 rounded-xl p-4 backdrop-blur-md">
                        <div class="flex justify-between text-sm mb-2 text-gray-300 font-mono"><span>Calories:</span><span id="builder-cal" class="text-green-400 font-bold">0 kcal</span></div>
                        <div class="flex justify-between text-2xl font-bold text-white mb-4 font-heading tracking-wide"><span>Total:</span><span class="text-yellow-500">‚Çπ<span id="builder-total">0</span></span></div>
                        <div class="flex gap-2">
                            <button onclick="app.clearPlate()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-3 rounded-xl font-bold transition text-xs">RESET</button>
                            <button onclick="app.addBuilderToCart()" class="flex-[2] bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-500 hover:to-orange-500 text-white py-3 rounded-xl font-bold transition shadow-lg touch-btn text-sm tracking-widest">ADD TO CART</button>
                        </div>
                    </div>
                </div>
                
                <div id="plate-drop-zone" class="flex-1 relative pointer-events-auto border-2 border-transparent transition-all rounded-3xl" ondrop="app.handleDrop(event)" ondragover="app.allowDrop(event)" ondragenter="this.classList.add('drop-target-active')" ondragleave="this.classList.remove('drop-target-active')">
                    <div class="absolute top-4 right-4 flex gap-4"><div id="trash-bin" class="w-20 h-20 bg-red-900/50 border-2 border-red-500 rounded-full flex items-center justify-center text-3xl transition-all shadow-[0_0_20px_rgba(239,68,68,0.3)] pointer-events-auto" ondragover="event.preventDefault(); this.classList.add('bin-active')" ondragleave="this.classList.remove('bin-active')" ondrop="app.handleBinDrop(event)">üóëÔ∏è</div></div>
                    <div class="absolute bottom-10 left-1/2 transform -translate-x-1/2 bg-black/50 backdrop-blur px-6 py-2 rounded-full border border-white/10 pointer-events-none text-center"><span class="text-xs text-gray-300 block">Drag background to rotate ‚Ä¢ Drag items to Bin ‚Ä¢ Click Item for Info</span></div>
                    <div id="selected-item-card" class="absolute top-4 left-4 bg-black/80 border border-yellow-500/50 p-4 rounded-xl backdrop-blur hidden transition-all duration-300">
                        <h4 id="sel-name" class="text-yellow-500 font-bold text-lg">Item Name</h4>
                        <p class="text-sm text-gray-300 mt-1 font-mono"><span id="sel-cal">0</span> kcal | Protein: <span id="sel-prot">0g</span></p>
                    </div>
                </div>
            </div>

            <!-- ORDER STATUS VIEW (Conditional) -->
            <div id="view-status" class="hidden-section w-full h-full pointer-events-auto flex flex-col items-center pt-24">
                <!-- State: Active Order -->
                <div id="status-active" class="glass w-full max-w-4xl h-[80vh] rounded-[2rem] p-8 flex flex-col items-center text-center relative hidden">
                    <button onclick="app.switchView('home')" class="absolute top-6 right-6 text-gray-500 hover:text-white text-2xl font-bold">&times;</button>
                    <h2 class="text-4xl font-heading text-white mb-2">Order Confirmed</h2>
                    <div class="text-xl text-yellow-500 font-mono mb-6">Token #<span id="status-token">0000</span></div>
                    <div class="w-48 h-48 rounded-full border-4 border-yellow-600 flex flex-col items-center justify-center mb-6 relative status-glow bg-black/40 flex-shrink-0">
                        <div class="text-5xl font-mono text-white font-bold" id="order-timer">15:00</div>
                        <div class="text-[10px] text-gray-400 uppercase tracking-widest mt-1">Time Remaining</div>
                        <div class="absolute inset-0 border-4 border-transparent border-t-yellow-400 rounded-full animate-spin" style="animation-duration: 3s;"></div>
                    </div>
                    <div class="w-full max-w-md bg-black/30 rounded-xl p-4 mb-4 flex-1 overflow-y-auto border border-white/10">
                        <h4 class="text-sm text-gray-400 uppercase tracking-widest mb-2 border-b border-white/10 pb-1">Items Ordered</h4>
                        <div id="order-details-list" class="space-y-2 text-left"></div>
                    </div>
                    <div class="w-full max-w-lg bg-gradient-to-r from-purple-900 to-indigo-900 p-4 rounded-2xl border border-purple-500 animate-pulse shadow-lg transform transition hover:scale-105 cursor-pointer flex-shrink-0" onclick="app.switchView('entertainment')">
                        <div class="flex items-center justify-between">
                            <div class="text-left"><h4 class="text-lg font-bold text-white mb-0">Don't just wait!</h4><p class="text-xs text-purple-200">Play games & win points</p></div>
                            <button class="bg-white text-purple-900 px-4 py-2 rounded-full font-bold text-sm">PLAY NOW ‚Üí</button>
                        </div>
                    </div>
                </div>

                <!-- State: No Order (Updated Layout) -->
                <div id="status-empty" class="w-full h-full flex flex-col items-center hidden relative overflow-hidden">
                    <!-- Top UI - Compact and Higher -->
                    <div class="text-center z-20 w-full max-w-2xl relative pt-2 px-4">
                         <button onclick="app.switchView('home')" class="absolute top-2 right-4 text-gray-400 hover:text-white px-4 py-1 text-sm border border-white/20 rounded-full hover:bg-white/10 transition z-50">EXIT</button>
                        <h2 class="text-4xl md:text-5xl font-heading text-red-400 mb-1 drop-shadow-lg">No Active Orders</h2>
                        <p class="text-sm md:text-base text-gray-300 mb-4 bg-black/40 p-2 rounded-lg backdrop-blur inline-block px-4 border border-white/5 font-light">Your stomach is empty! Order something delicious.</p>
                        <div class="flex flex-row gap-3 justify-center mb-2">
                            <button onclick="app.switchView('menu')" class="px-5 py-2 bg-gradient-to-r from-yellow-600 to-orange-600 text-white font-bold text-sm rounded-full shadow-lg hover:scale-105 transition touch-btn border border-white/20">ORDER NOW üçΩÔ∏èüöÄ</button>
                            <button onclick="window.location.href='c3.html'" class="px-5 py-2 bg-gradient-to-r from-blue-600 to-cyan-600 text-white font-bold text-sm rounded-full shadow-lg hover:scale-105 transition touch-btn border border-white/20">VR BUILDER üöÄ</button>
                        </div>
                    </div>
                    <!-- 3D Model Area - Takes Most Space -->
                    <div class="flex-1 w-full relative flex items-center justify-center pointer-events-auto z-10" id="burger-rotation-zone">
                        <div class="text-center opacity-50 animate-pulse absolute bottom-6 pointer-events-none">
                             <p class="text-xs text-gray-400 uppercase tracking-[0.3em]">Drag to Rotate 3D Model</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ENTERTAINMENT & GAMES -->
            <div id="view-entertainment" class="hidden-section glass w-full max-w-6xl h-[85vh] rounded-[2rem] p-8 flex flex-col pointer-events-auto bg-[#0d0604] border border-[#a1887f]/20">
                <div class="flex justify-between items-center mb-6 border-b border-[#a1887f]/20 pb-6 flex-shrink-0">
                    <h3 class="text-4xl font-heading text-[#efebe9]">Fun Zone</h3>
                    <div class="flex gap-4">
                        <div class="text-right"><div class="text-xs text-gray-500 uppercase">Score</div><div id="game-score" class="text-xl font-mono text-yellow-500 font-bold">0</div></div>
                        <div class="text-right"><div class="text-xs text-gray-500 uppercase">Time</div><div id="game-time" class="text-xl font-mono text-white font-bold">02:00</div></div>
                    </div>
                </div>
                <div class="flex-1 flex flex-col md:flex-row gap-6 overflow-hidden">
                    <div class="w-full md:w-1/4 space-y-4 overflow-y-auto pr-2">
                        <button onclick="gameManager.loadGame('catch')" class="w-full p-4 bg-gradient-to-r from-blue-900 to-blue-800 border border-blue-700 rounded-xl hover:bg-blue-700 text-left transition group touch-btn shadow-lg"><h4 class="font-bold text-blue-100 group-hover:text-white">Burger Catch</h4><p class="text-[10px] text-blue-300">Reflex ‚Ä¢ Easy</p></button>
                        <button onclick="gameManager.loadGame('memory')" class="w-full p-4 bg-gradient-to-r from-purple-900 to-purple-800 border border-purple-700 rounded-xl hover:bg-purple-700 text-left transition group touch-btn shadow-lg"><h4 class="font-bold text-purple-100 group-hover:text-white">Memory Match</h4><p class="text-[10px] text-purple-300">Brain ‚Ä¢ Hard (20 Cards)</p></button>
                        <button onclick="gameManager.loadGame('whack')" class="w-full p-4 bg-gradient-to-r from-red-900 to-red-800 border border-red-700 rounded-xl hover:bg-red-700 text-left transition group touch-btn shadow-lg"><h4 class="font-bold text-red-100 group-hover:text-white">Whack-a-Food</h4><p class="text-[10px] text-red-300">Action ‚Ä¢ Fast</p></button>
                        <button onclick="gameManager.loadGame('sudoku')" class="w-full p-4 bg-gradient-to-r from-gray-800 to-gray-700 border border-gray-600 rounded-xl hover:bg-gray-600 text-left transition group touch-btn shadow-lg"><h4 class="font-bold text-gray-200 group-hover:text-white">Sudoku Lite</h4><p class="text-[10px] text-gray-400">Puzzle ‚Ä¢ Hard</p></button>
                    </div>
                    <div id="game-stage" class="flex-1 bg-black/40 rounded-2xl flex items-center justify-center relative overflow-hidden border border-[#a1887f]/10 shadow-inner">
                        <div class="text-center animate-pulse"><p class="text-[#5d4037] font-mono text-sm">SELECT A GAME TO START</p></div>
                        <div id="game-over" class="game-over-overlay"><h2 class="text-6xl font-comic text-red-500 mb-4 animate-bounce">GAME OVER</h2><p class="text-2xl mb-8">Score: <span id="final-score" class="text-yellow-500">0</span></p><button onclick="gameManager.stopGames()" class="bg-white text-black px-8 py-3 rounded-full font-bold hover:bg-gray-200 text-lg">EXIT</button></div>
                    </div>
                </div>
            </div>

            <!-- KITCHEN DISPLAY SYSTEM (KDS) -->
            <div id="view-kitchen" class="hidden-section glass w-full max-w-7xl h-[90vh] rounded-[2rem] p-8 flex flex-col pointer-events-auto bg-[#0a0503] border border-gray-800">
                <div class="flex justify-between items-center mb-8 border-b border-gray-800 pb-6 flex-shrink-0">
                    <h3 class="text-3xl font-heading text-red-500">Kitchen Display System</h3>
                    <div class="flex gap-4 items-center"><span class="text-xs text-green-400 font-mono animate-pulse">LIVE FEED</span><button onclick="app.switchView('home')" class="text-gray-500 hover:text-white text-2xl">&times;</button></div>
                </div>
                <div class="grid grid-cols-3 gap-6 h-full overflow-hidden">
                    <div class="kds-col"><div class="kds-header text-red-400">PENDING</div><div id="kds-pending" class="flex-1 overflow-y-auto space-y-4"></div></div>
                    <div class="kds-col"><div class="kds-header text-yellow-400">COOKING</div><div id="kds-cooking" class="flex-1 overflow-y-auto space-y-4"></div></div>
                    <div class="kds-col"><div class="kds-header text-green-400">READY</div><div id="kds-ready" class="flex-1 overflow-y-auto space-y-4"></div></div>
                </div>
            </div>

            <!-- ADMIN DASHBOARD -->
            <div id="view-admin" class="hidden-section glass w-full max-w-7xl h-[85vh] rounded-[2rem] p-8 flex flex-col pointer-events-auto bg-[#0a0503] border border-gray-800">
                <div class="flex justify-between items-center mb-8 border-b border-gray-800 pb-6 flex-shrink-0">
                    <h3 class="text-3xl font-heading text-gray-200">Management Console</h3>
                    <div class="flex gap-4 items-center"><span class="text-xs text-green-400 font-mono">SYSTEM ONLINE</span><button onclick="app.switchView('home')" class="text-gray-500 hover:text-white text-2xl">&times;</button></div>
                </div>
                <div class="text-gray-500 text-center mt-20">Admin Panel Active - KDS & Inventory Modules Loaded</div>
            </div>

        </main>

        <!-- Cart Sidebar -->
        <div id="cart-sidebar" class="fixed top-0 right-0 h-full w-full md:w-[400px] bg-[#0d0604] border-l border-[#5d4037] transform translate-x-full transition-transform duration-500 z-50 flex flex-col shadow-2xl interactive">
            <div class="p-6 border-b border-[#3e2723] flex justify-between items-center bg-[#1a0f0d]">
                <div><h3 class="text-2xl font-heading text-[#d7ccc8]">Order Summary</h3><p class="text-xs text-gray-500">Table #5 ‚Ä¢ Guest</p></div>
                <button onclick="app.toggleCart()" class="text-gray-500 hover:text-white transition w-8 h-8 rounded-full flex items-center justify-center hover:bg-white/10">&times;</button>
            </div>
            <div id="cart-items" class="flex-1 overflow-y-auto p-6 space-y-4"></div>
            <div class="p-6 bg-[#1a0f0d] border-t border-[#3e2723] space-y-4">
                <div class="flex justify-between text-sm text-gray-400"><span>Subtotal</span><span>‚Çπ<span id="cart-subtotal">0.00</span></span></div>
                <div class="flex justify-between text-sm text-gray-400"><span>GST (5%)</span><span>‚Çπ<span id="cart-tax">0.00</span></span></div>
                <div class="flex justify-between text-xl font-bold text-[#d7ccc8]"><span>Total Pay</span><span class="text-yellow-500">‚Çπ<span id="cart-total">0.00</span></span></div>
                <button onclick="app.openPaymentModal()" class="w-full bg-gradient-to-r from-yellow-700 to-yellow-600 hover:from-yellow-600 hover:to-yellow-500 text-white py-4 rounded-xl font-bold transition shadow-lg tracking-wide border border-[#6d4c41] touch-btn">SECURE CHECKOUT</button>
            </div>
        </div>

        <!-- Feedback Modal -->
        <div id="feedback-modal" class="fixed inset-0 bg-black/90 z-[70] hidden flex items-center justify-center interactive backdrop-blur-md">
            <div class="bg-[#1a0f0d] border border-[#5d4037] w-full max-w-md rounded-3xl p-8 relative shadow-2xl transition-all" id="feedback-content">
                <div id="feedback-form">
                    <h3 class="text-2xl font-heading text-[#d7ccc8] mb-6 text-center">Rate Your Experience</h3>
                    <div id="feedback-user-fields">
                        <input type="text" id="fb-name" placeholder="Your Name" class="w-full bg-[#2c1b18] border border-[#3e2723] rounded-lg p-3 text-white mb-3 focus:border-yellow-600 outline-none">
                        <input type="email" id="fb-email" placeholder="Email Address" class="w-full bg-[#2c1b18] border border-[#3e2723] rounded-lg p-3 text-white mb-4 focus:border-yellow-600 outline-none">
                    </div>
                    <div class="flex justify-center gap-2 mb-6 star-rating">
                        <span onclick="app.handleStarClick(1)">‚òÖ</span><span onclick="app.handleStarClick(2)">‚òÖ</span><span onclick="app.handleStarClick(3)">‚òÖ</span><span onclick="app.handleStarClick(4)">‚òÖ</span><span onclick="app.handleStarClick(5)">‚òÖ</span>
                    </div>
                    <textarea class="w-full bg-black/30 border border-[#3e2723] rounded-xl p-4 text-sm text-gray-300 mb-6 focus:border-yellow-600 outline-none transition" placeholder="Any suggestions?"></textarea>
                    <div class="flex gap-3">
                        <button onclick="document.getElementById('feedback-modal').classList.add('hidden')" class="flex-1 py-3 rounded-xl text-gray-500 hover:bg-white/5 font-bold transition">Cancel</button>
                        <button onclick="app.submitFeedback()" class="flex-1 bg-gradient-to-r from-yellow-700 to-yellow-600 text-white rounded-xl font-bold shadow-lg hover:shadow-yellow-600/20 transition touch-btn">Submit Feedback</button>
                    </div>
                    <p id="fb-error" class="text-red-500 text-xs mt-2 text-center hidden">You have already submitted feedback.</p>
                </div>
                <div id="feedback-success" class="hidden text-center">
                    <div class="flex flex-col items-center justify-center py-6">
                        <div class="checkmark-wrapper"><svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52"><circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/><path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/></svg></div>
                        <h3 class="text-3xl font-heading text-green-500 mt-6 mb-2">Thank You!</h3>
                        <p class="text-gray-400">Feedback Submitted Successfully</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Modal -->
        <div id="payment-modal" class="fixed inset-0 bg-black/90 z-[60] hidden flex items-center justify-center interactive backdrop-blur-md">
            <div class="bg-[#1a0f0d] border border-[#5d4037] w-full max-w-lg rounded-3xl p-8 relative shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-heading text-[#d7ccc8]">Payment Gateway</h3>
                    <div class="text-xs bg-green-900/30 text-green-400 px-2 py-1 rounded border border-green-800">256-bit Secure</div>
                </div>
                <!-- Step 0: User Details -->
                <div id="pay-step-details">
                    <h3 class="text-xl text-[#d7ccc8] mb-4">Your Details</h3>
                    <input type="text" id="user-name" placeholder="Name" class="w-full bg-[#2c1b18] border border-[#3e2723] rounded-lg p-3 text-white mb-3 focus:border-yellow-600 outline-none">
                    <input type="tel" id="user-phone" placeholder="Phone Number" class="w-full bg-[#2c1b18] border border-[#3e2723] rounded-lg p-3 text-white mb-3 focus:border-yellow-600 outline-none">
                    <input type="email" id="user-email" placeholder="Email Address (Optional)" class="w-full bg-[#2c1b18] border border-[#3e2723] rounded-lg p-3 text-white mb-6 focus:border-yellow-600 outline-none">
                    <button onclick="app.submitDetails()" class="w-full bg-yellow-600 text-black font-bold py-3 rounded-xl hover:bg-yellow-500 transition">Next</button>
                    <button onclick="app.closePaymentModal()" class="w-full mt-2 py-2 rounded-xl text-gray-500 hover:text-white text-sm transition">Cancel</button>
                </div>
                <!-- Step 1: Selection -->
                <div id="pay-step-1" class="hidden">
                     <div class="space-y-3 mb-6">
                        <button onclick="app.showPaymentStep('upi')" class="w-full bg-[#2c1b18] hover:bg-[#3e2723] p-4 rounded-xl border border-[#3e2723] flex items-center gap-4 transition group touch-btn">
                            <div class="w-12 h-12 bg-[#4e342e] rounded-full flex items-center justify-center text-white text-2xl">üì≤</div>
                            <div class="text-left flex-1">
                                <div class="font-bold text-[#d7ccc8]">UPI / QR Code</div>
                                <div class="text-xs text-gray-500">Scan via GPay, PhonePe</div>
                            </div>
                        </button>
                        <button onclick="app.showPaymentStep('card')" class="w-full bg-[#2c1b18] hover:bg-[#3e2723] p-4 rounded-xl border border-[#3e2723] flex items-center gap-4 transition group touch-btn">
                            <div class="w-12 h-12 bg-[#4e342e] rounded-full flex items-center justify-center text-white text-2xl">üí≥</div>
                            <div class="text-left flex-1">
                                <div class="font-bold text-[#d7ccc8]">Credit / Debit Card</div>
                                <div class="text-xs text-gray-500">Visa, Mastercard, Rupay</div>
                            </div>
                        </button>
                    </div>
                    <button onclick="app.showPaymentStep('details')" class="w-full py-3 rounded-xl text-gray-500 hover:text-white text-sm transition">Back to Details</button>
                </div>
                <!-- UPI Step -->
                <div id="pay-step-upi" class="hidden">
                    <div class="mb-4"><label class="text-sm text-gray-400 block mb-2">UPI ID</label><div class="flex gap-2"><input type="text" placeholder="e.g. mobile@upi" class="flex-1 bg-[#2c1b18] border border-[#3e2723] rounded-lg p-3 text-white outline-none focus:border-yellow-600"><button class="bg-blue-600 px-4 rounded-lg text-sm font-bold hover:bg-blue-500" onclick="// BACKEND: Verify UPI">VERIFY</button></div></div>
                    <p class="text-gray-400 text-sm mb-2">Or Pay via App:</p>
                    <div class="payment-grid mb-6">
                        <div class="pay-icon"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/1200px-Google_%22G%22_logo.svg.png" alt="GPay"></div> 
                        <div class="pay-icon"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e1/PhonePe_Logo.svg/2560px-PhonePe_Logo.svg.png" alt="PhonePe"></div>
                        <div class="pay-icon"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/24/Paytm_Logo_%28standalone%29.svg/1200px-Paytm_Logo_%28standalone%29.svg.png" alt="Paytm"></div>
                        <div class="pay-icon"><img src="https://upload.wikimedia.org/wikipedia/commons/f/f2/BHIM_Logo.png" alt="BHIM"></div>
                        <div class="pay-icon"><div class="text-black font-bold">CRED</div></div>
                        <div class="pay-icon"><div class="text-black font-bold">Mobi</div></div>
                    </div>
                    <button onclick="app.processPayment()" class="w-full bg-green-700 hover:bg-green-600 text-white py-3 rounded-xl font-bold touch-btn">Simulate Payment Success</button>
                    <button onclick="app.showPaymentStep('1')" class="mt-4 text-gray-500 hover:text-white text-sm w-full">Back</button>
                </div>
                <!-- Card Step -->
                <div id="pay-step-card" class="hidden">
                    <div class="bg-gradient-to-r from-blue-900 to-blue-700 p-5 rounded-2xl mb-6 shadow-lg relative overflow-hidden">
                        <div class="absolute top-4 right-4 flex gap-2"><img src="https://upload.wikimedia.org/wikipedia/commons/5/5e/Visa_Inc._logo.svg" class="h-6 bg-white rounded px-1"><img src="https://upload.wikimedia.org/wikipedia/commons/c/cb/Rupay-Logo.png" class="h-6 bg-white rounded px-1"></div>
                        <div class="flex justify-between mb-8"><div class="text-xl font-bold italic text-white/80">BANK</div></div>
                        <div class="text-2xl font-mono tracking-widest text-white mb-4">XXXX XXXX XXXX XXXX</div>
                        <div class="flex justify-between"><div class="text-xs text-white/70">CARD HOLDER<br><span class="text-sm text-white">YOUR NAME</span></div><div class="text-xs text-white/70">EXPIRES<br><span class="text-sm text-white">MM/YY</span></div></div>
                    </div>
                    <form onsubmit="event.preventDefault(); app.processPayment();" class="space-y-3">
                        <input type="text" placeholder="Card Number" class="w-full bg-[#2c1b18] border border-[#3e2723] rounded-lg p-3 text-white outline-none focus:border-blue-500">
                        <div class="flex gap-3"><input type="text" placeholder="MM/YY" class="w-1/2 bg-[#2c1b18] border border-[#3e2723] rounded-lg p-3 text-white outline-none focus:border-blue-500"><input type="text" placeholder="CVV" class="w-1/2 bg-[#2c1b18] border border-[#3e2723] rounded-lg p-3 text-white outline-none focus:border-blue-500"></div>
                        <input type="text" placeholder="Card Holder Name" class="w-full bg-[#2c1b18] border border-[#3e2723] rounded-lg p-3 text-white outline-none focus:border-blue-500">
                        <button type="submit" class="w-full bg-blue-700 hover:bg-blue-600 text-white py-3 rounded-xl font-bold mt-4 touch-btn">Pay Now</button>
                    </form>
                    <button onclick="app.showPaymentStep('1')" class="mt-4 w-full text-gray-500 hover:text-white text-sm">Back</button>
                </div>
            </div>
        </div>

        <!-- Success Modal (Order Confirmed) -->
        <div id="token-modal" class="fixed inset-0 bg-black/95 z-[70] hidden flex items-center justify-center interactive backdrop-blur-xl">
            <div class="bg-[#1a0f0d] border border-[#5d4037] w-full max-w-sm rounded-3xl p-8 text-center">
                <div class="checkmark-wrapper mb-4"><svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52"><circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/><path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/></svg></div>
                <h2 class="text-2xl font-heading text-[#d7ccc8] mb-2">Order Confirmed!</h2>
                <p class="text-gray-500 mb-6 text-sm">Your feast is being prepared.</p>
                <div class="bg-[#2c1b18] border border-[#3e2723] rounded-2xl p-6 mb-6">
                    <p class="text-[10px] text-gray-500 uppercase tracking-[0.2em] mb-2">Token</p>
                    <p id="token-display" class="text-5xl font-mono font-bold text-[#d7ccc8] tracking-widest">#0000</p>
                </div>
                <button onclick="app.goToStatus()" class="w-full bg-[#4e342e] text-white font-bold py-3 rounded-xl touch-btn hover:bg-[#5d4037] transition">Check Order Status</button>
            </div>
        </div>

        <!-- Item Portion Modal -->
        <div id="portion-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center interactive backdrop-blur-sm p-4">
            <div class="bg-[#1a0f0d] border border-[#5d4037] w-full max-w-md rounded-3xl p-8 relative">
                <button onclick="document.getElementById('portion-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-500 hover:text-white text-2xl">&times;</button>
                <h3 id="pm-title" class="text-2xl font-heading text-[#efebe9] mb-2">Item Name</h3>
                <p id="pm-desc" class="text-gray-500 text-sm mb-4">Description...</p>
                <div class="bg-red-900/20 p-3 rounded-lg border border-red-900/50 mb-6"><span class="text-xs text-red-400 font-bold uppercase tracking-widest">‚ö†Ô∏è Allergens:</span><span id="pm-allergens" class="text-xs text-red-200 ml-2">None</span></div>
                <div class="space-y-4 mb-6"><div class="text-xs text-gray-400 uppercase tracking-widest">Select Portion Size</div><div id="pm-options" class="space-y-2"></div></div>
                <div class="flex justify-between items-center pt-4 border-t border-[#3e2723]"><div class="text-xl font-bold text-[#d7ccc8]">‚Çπ<span id="pm-total">0</span></div><button id="pm-add-btn" class="bg-yellow-600 text-black px-6 py-2 rounded-lg font-bold shadow-lg touch-btn hover:bg-yellow-500 transition">Add to Order</button></div>
            </div>
        </div>

    </div>

    <!-- Application Logic -->
    <script>
        // --- DATA ---
        const menuItems = [
            { id: 1, type: 'non-veg', name: "Maharaja Burger", img: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&w=600&q=80', desc: "Double patty spiced chicken, cheese.", allergens: ["Gluten", "Dairy"], portions: [ {label: "Small", price: 199, cal: 450}, {label: "Regular", price: 249, cal: 650} ] },
            { id: 2, type: 'veg', name: "Paneer Pizza", img: 'https://images.unsplash.com/photo-1574071318508-1cdbab80d002?auto=format&fit=crop&w=600&q=80', desc: "Tandoori paneer, red paprika.", allergens: ["Dairy", "Gluten"], portions: [ {label: "Personal", price: 299, cal: 600}, {label: "Medium", price: 399, cal: 900} ] },
            { id: 3, type: 'non-veg', name: "Butter Chicken", img: 'https://images.unsplash.com/photo-1588166524941-3bf61a9c41db?auto=format&fit=crop&w=600&q=80', desc: "Rich creamy tomato curry.", allergens: ["Dairy", "Nuts"], portions: [ {label: "Half", price: 280, cal: 500}, {label: "Full", price: 450, cal: 950} ] },
            { id: 4, type: 'non-veg', name: "Hyd Biryani", img: 'https://images.unsplash.com/photo-1563379091339-03b21ab4a4f8?auto=format&fit=crop&w=600&q=80', desc: "Aromatic basmati rice.", allergens: ["Nuts"], portions: [ {label: "Half", price: 220, cal: 550}, {label: "Full", price: 350, cal: 1100} ] },
            { id: 5, type: 'veg', name: "Street Tacos", img: 'https://images.unsplash.com/photo-1551504734-5ee1c4a1479b?auto=format&fit=crop&w=600&q=80', desc: "Spicy beans & salsa.", allergens: ["Corn"], portions: [ {label: "2 pcs", price: 199, cal: 300}, {label: "4 pcs", price: 299, cal: 600} ] },
            { id: 6, type: 'non-veg', name: "Spicy Ramen", img: 'https://images.unsplash.com/photo-1569718212165-3a8278d5f624?auto=format&fit=crop&w=600&q=80', desc: "Wheat noodles in broth.", allergens: ["Gluten", "Soy", "Egg"], portions: [ {label: "Regular", price: 320, cal: 600}, {label: "Large", price: 390, cal: 800} ] },
            { id: 7, type: 'veg', name: "Gulab Jamun", img: 'https://images.unsplash.com/photo-1616031026960-91a5fb82302e?auto=format&fit=crop&w=600&q=80', desc: "Fried dough balls.", allergens: ["Dairy", "Gluten"], portions: [ {label: "2 pcs", price: 80, cal: 200}, {label: "4 pcs", price: 150, cal: 400} ] },
            { id: 8, type: 'veg', name: "Filter Coffee", img: 'https://images.unsplash.com/photo-1497935586351-b67a49e012bf?auto=format&fit=crop&w=600&q=80', desc: "South Indian style.", allergens: ["Dairy"], portions: [ {label: "Cup", price: 80, cal: 60} ] },
            { id: 9, type: 'veg', name: "Caesar Salad", img: 'https://images.unsplash.com/photo-1550304943-4f24f54ddde9?auto=format&fit=crop&w=600&q=80', desc: "Fresh romaine lettuce & croutons.", allergens: ["Gluten", "Dairy"], portions: [ {label: "Bowl", price: 180, cal: 150} ] },
            { id: 10, type: 'non-veg', name: "Fish & Chips", img: 'https://images.unsplash.com/photo-1579202673506-ca3ce28943ef?auto=format&fit=crop&w=600&q=80', desc: "Crispy battered fish fillets.", allergens: ["Fish", "Gluten"], portions: [ {label: "Plate", price: 350, cal: 700} ] },
            { id: 11, type: 'veg', name: "Sushi Platter", img: 'https://images.unsplash.com/photo-1579871494447-9811cf80d66c?auto=format&fit=crop&w=600&q=80', desc: "Assorted veg sushi rolls.", allergens: ["Soy"], portions: [ {label: "6 pcs", price: 400, cal: 300} ] },
            { id: 12, type: 'non-veg', name: "Steak", img: 'https://images.unsplash.com/photo-1600891964092-4316c288032e?auto=format&fit=crop&w=600&q=80', desc: "Grilled tenderloin steak.", allergens: [], portions: [ {label: "200g", price: 650, cal: 800} ] },
            { id: 13, type: 'veg', name: "Pancakes", img: 'https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?auto=format&fit=crop&w=600&q=80', desc: "Fluffy pancakes with syrup.", allergens: ["Gluten", "Dairy", "Egg"], portions: [ {label: "Stack", price: 200, cal: 500} ] },
            { id: 14, type: 'veg', name: "Pasta Alfredo", img: 'https://images.unsplash.com/photo-1612874742237-982867143825?auto=format&fit=crop&w=600&q=80', desc: "Creamy white sauce pasta.", allergens: ["Gluten", "Dairy"], portions: [ {label: "Bowl", price: 300, cal: 600} ] },
            { id: 15, type: 'non-veg', name: "Chicken Wings", img: 'https://images.unsplash.com/photo-1567620832903-9fc6debc209f?auto=format&fit=crop&w=600&q=80', desc: "Spicy BBQ wings.", allergens: [], portions: [ {label: "6 pcs", price: 250, cal: 400} ] },
            { id: 16, type: 'veg', name: "Samosa", img: 'https://images.unsplash.com/photo-1601050690597-df0568f70950?auto=format&fit=crop&w=600&q=80', desc: "Crispy pastry with potatoes.", allergens: ["Gluten"], portions: [ {label: "2 pcs", price: 60, cal: 250} ] },
            { id: 17, type: 'veg', name: "Donut", img: 'https://images.unsplash.com/photo-1552072805-2a9039d00e5c?auto=format&fit=crop&w=600&q=80', desc: "Chocolate glazed donut.", allergens: ["Gluten", "Dairy"], portions: [ {label: "1 pc", price: 90, cal: 300} ] },
            { id: 18, type: 'veg', name: "Ice Cream", img: 'https://images.unsplash.com/photo-1497034825429-c343d7c6a68f?auto=format&fit=crop&w=600&q=80', desc: "Vanilla scoop.", allergens: ["Dairy"], portions: [ {label: "Scoop", price: 120, cal: 200} ] },
            { id: 19, type: 'non-veg', name: "Egg Toast", img: 'https://images.unsplash.com/photo-1525351484163-7529414395d8?auto=format&fit=crop&w=600&q=80', desc: "Fried egg on toast.", allergens: ["Egg", "Gluten"], portions: [ {label: "Plate", price: 150, cal: 350} ] },
            { id: 20, type: 'veg', name: "Fruit Salad", img: 'https://images.unsplash.com/photo-1519996529931-28324d1a6305?auto=format&fit=crop&w=600&q=80', desc: "Seasonal fruits mix.", allergens: [], portions: [ {label: "Bowl", price: 220, cal: 150} ] }
        ];

        let cart = SharedCart.getCart();
        let activeOrders = [];
        let lastOrder = null;
        let plateBuilderState = { items: [], total: 0, cal: 0 };
        let orderTimerInterval = null;
        let submittedEmails = new Set(); 
        let hasPaid = false; // Track payment status for session
        const wordList = ["Super Delicious!", "Yummy!", "Tasty!", "Savory!", "Flavorful!", "Fresh!", "Amazing!", "Awesome!", "Perfect!", "Lovely!", "Scrumptious!", "Mouthwatering!", "Irresistible!"];

        // --- THREE.JS SETUP ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x1a0f0d, 0.015);
        
        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 18, 22);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.maxDistance = 40;
        
        const ambientLight = new THREE.AmbientLight(0xffccaa, 0.4); 
        scene.add(ambientLight);
        const mainSpot = new THREE.SpotLight(0xffaa55, 2.5);
        mainSpot.position.set(0, 30, 0);
        mainSpot.castShadow = true;
        scene.add(mainSpot);

        // Groups
        const mainGroup = new THREE.Group(); 
        const builderGroup = new THREE.Group(); 
        const eatingGroup = new THREE.Group();
        scene.add(mainGroup);
        scene.add(builderGroup);
        scene.add(eatingGroup);
        builderGroup.visible = false;
        eatingGroup.visible = false;

        // --- PROCEDURAL 3D BURGER (REPLACES GLTFLoader) ---
        function createProceduralBurger() {
            const burgerGroup = new THREE.Group();
            
            // Bottom Bun
            const bunGeo = new THREE.CylinderGeometry(2, 2, 0.8, 32);
            const bunMat = new THREE.MeshStandardMaterial({ color: 0xeec591, roughness: 0.3 });
            const bottomBun = new THREE.Mesh(bunGeo, bunMat);
            bottomBun.position.y = -0.4;
            burgerGroup.add(bottomBun);

            // Lettuce
            const letGeo = new THREE.CylinderGeometry(2.2, 2.2, 0.1, 32);
            const letMat = new THREE.MeshStandardMaterial({ color: 0x4caf50, roughness: 0.8 });
            const lettuce = new THREE.Mesh(letGeo, letMat);
            lettuce.position.y = 0.1;
            // add some waviness
            const letPos = lettuce.geometry.attributes.position;
            for(let i=0; i<letPos.count; i++) {
                letPos.setY(i, letPos.getY(i) + Math.sin(letPos.getX(i)*2)*0.1);
            }
            burgerGroup.add(lettuce);

            // Patty
            const meatGeo = new THREE.CylinderGeometry(2, 2, 0.6, 32);
            const meatMat = new THREE.MeshStandardMaterial({ color: 0x5d4037, roughness: 0.9 });
            const patty = new THREE.Mesh(meatGeo, meatMat);
            patty.position.y = 0.5;
            burgerGroup.add(patty);

            // Cheese
            const cheeseGeo = new THREE.BoxGeometry(3, 0.1, 3);
            const cheeseMat = new THREE.MeshStandardMaterial({ color: 0xffd700 });
            const cheese = new THREE.Mesh(cheeseGeo, cheeseMat);
            cheese.position.y = 0.85;
            cheese.rotation.y = Math.PI / 4;
            burgerGroup.add(cheese);

            // Top Bun
            const topBunGeo = new THREE.SphereGeometry(2, 32, 16, 0, Math.PI * 2, 0, Math.PI/2);
            const topBun = new THREE.Mesh(topBunGeo, bunMat);
            topBun.scale.y = 0.8;
            topBun.position.y = 0.9;
            burgerGroup.add(topBun);
            
            // Sesame Seeds
            const seedGeo = new THREE.SphereGeometry(0.08, 4, 4);
            const seedMat = new THREE.MeshStandardMaterial({ color: 0xffe0b2 });
            for(let i=0; i<30; i++) {
                const seed = new THREE.Mesh(seedGeo, seedMat);
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.random() * Math.PI / 3;
                const r = 2;
                seed.position.set(
                    r * Math.sin(phi) * Math.cos(theta),
                    0.9 + r * Math.cos(phi) * 0.8, // adhere to scaled bun
                    r * Math.sin(phi) * Math.sin(theta)
                );
                burgerGroup.add(seed);
            }

            return burgerGroup;
        }

        const burgerModel = createProceduralBurger();
        // Initial scale 0 to "pop in"
        burgerModel.scale.set(0,0,0);
        eatingGroup.add(burgerModel);
        
        // Hide procedural burger - we'll use doll.glb instead
        burgerModel.visible = false;

        // ========== DOLL.GLB 3D MODEL LOADER ==========
        let dollModel = null;
        let isDraggingDoll = false;
        let previousDollX = 0;
        let previousDollY = 0;
        
        // Responsive scale based on screen size - LARGER for better visibility
        function getDollScale() {
            const w = window.innerWidth;
            if (w < 640) return 5;        // Mobile - larger
            if (w < 1024) return 6;       // Tablet - larger
            return 7;                      // Desktop - larger
        }
        
        // Responsive camera position for doll view - closer for better view
        function getDollCameraZ() {
            const w = window.innerWidth;
            if (w < 640) return 18;       // Mobile
            if (w < 1024) return 16;      // Tablet
            return 14;                     // Desktop - closer
        }
        
        const gltfLoader = new THREE.GLTFLoader();
        gltfLoader.load('doll.glb', 
            function(gltf) {
                dollModel = gltf.scene;
                
                // Center the model
                const box = new THREE.Box3().setFromObject(dollModel);
                const center = box.getCenter(new THREE.Vector3());
                dollModel.position.sub(center);
                
                // Set responsive scale
                const scale = getDollScale();
                dollModel.scale.set(scale, scale, scale);
                dollModel.position.y = -2;
                
                // Enable shadows
                dollModel.traverse(function(child) {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                });
                
                eatingGroup.add(dollModel);
                console.log('Doll model loaded successfully');
            },
            function(xhr) {
                console.log('Loading doll: ' + (xhr.loaded / xhr.total * 100) + '%');
            },
            function(error) {
                console.error('Error loading doll.glb:', error);
                // Fallback: show procedural burger if doll fails to load
                burgerModel.visible = true;
                burgerModel.scale.set(1,1,1);
            }
        );
        
        // Doll rotation drag handlers
        function onDollDragStart(e) {
            if (app.state.view !== 'status' || !dollModel || !eatingGroup.visible) return;
            isDraggingDoll = true;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            previousDollX = clientX;
            previousDollY = clientY;
            e.preventDefault();
        }
        
        function onDollDragMove(e) {
            if (!isDraggingDoll || !dollModel) return;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const deltaX = clientX - previousDollX;
            const deltaY = clientY - previousDollY;
            
            // Rotate doll based on drag
            dollModel.rotation.y += deltaX * 0.01;
            dollModel.rotation.x += deltaY * 0.005;
            
            // Clamp X rotation to prevent flipping
            dollModel.rotation.x = Math.max(-0.5, Math.min(0.5, dollModel.rotation.x));
            
            previousDollX = clientX;
            previousDollY = clientY;
            e.preventDefault();
        }
        
        function onDollDragEnd() {
            isDraggingDoll = false;
        }
        
        // Attach doll rotation events to burger-rotation-zone
        const dollRotationZone = document.getElementById('burger-rotation-zone');
        if (dollRotationZone) {
            dollRotationZone.addEventListener('mousedown', onDollDragStart);
            dollRotationZone.addEventListener('mousemove', onDollDragMove);
            dollRotationZone.addEventListener('mouseup', onDollDragEnd);
            dollRotationZone.addEventListener('mouseleave', onDollDragEnd);
            dollRotationZone.addEventListener('touchstart', onDollDragStart, { passive: false });
            dollRotationZone.addEventListener('touchmove', onDollDragMove, { passive: false });
            dollRotationZone.addEventListener('touchend', onDollDragEnd);
        }
        
        // Also allow rotation on the canvas when in status view
        renderer.domElement.addEventListener('mousedown', function(e) {
            if (app.state.view === 'status' && !lastOrder && dollModel && eatingGroup.visible) {
                onDollDragStart(e);
            }
        });
        renderer.domElement.addEventListener('mousemove', onDollDragMove);
        renderer.domElement.addEventListener('mouseup', onDollDragEnd);
        renderer.domElement.addEventListener('touchstart', function(e) {
            if (app.state.view === 'status' && !lastOrder && dollModel && eatingGroup.visible) {
                onDollDragStart(e);
            }
        }, { passive: false });
        renderer.domElement.addEventListener('touchmove', onDollDragMove, { passive: false });
        renderer.domElement.addEventListener('touchend', onDollDragEnd);
        
        // Update doll scale on window resize
        window.addEventListener('resize', function() {
            if (dollModel) {
                const scale = getDollScale();
                dollModel.scale.set(scale, scale, scale);
            }
        });
        // ========== END DOLL.GLB LOADER ==========

        // Particle System (Steam)
        const particleCount = 200;
        const particles = new THREE.BufferGeometry();
        const pMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 0.2, transparent: true, opacity: 0.0, blending: THREE.AdditiveBlending });
        const pPositions = new Float32Array(particleCount * 3);
        const pVelocities = [];
        for (let i = 0; i < particleCount; i++) {
            pPositions[i*3] = (Math.random() - 0.5) * 5;
            pPositions[i*3+1] = Math.random() * 2;
            pPositions[i*3+2] = (Math.random() - 0.5) * 5;
            pVelocities.push({ y: Math.random() * 0.03 + 0.02, x: (Math.random()-0.5)*0.01, z: (Math.random()-0.5)*0.01 });
        }
        particles.setAttribute('position', new THREE.BufferAttribute(pPositions, 3));
        const particleSystem = new THREE.Points(particles, pMaterial);
        builderGroup.add(particleSystem);

        const imgLoader = new THREE.TextureLoader();
        const radius = 9;
        menuItems.forEach((item, index) => {
            const angle = (index / menuItems.length) * Math.PI * 2;
            const x = Math.cos(angle) * radius;
            const z = Math.sin(angle) * radius;
            const plateGeo = new THREE.CylinderGeometry(1.4, 1.2, 0.1, 32);
            const plateMat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.2 });
            const plate = new THREE.Mesh(plateGeo, plateMat);
            const foodGeo = new THREE.CircleGeometry(1.1, 32);
            const tex = imgLoader.load(item.img);
            tex.center.set(0.5, 0.5);
            const foodMat = new THREE.MeshBasicMaterial({ map: tex });
            const food = new THREE.Mesh(foodGeo, foodMat);
            food.rotation.x = -Math.PI / 2;
            food.position.y = 0.06;
            const group = new THREE.Group();
            group.add(plate, food);
            const pivot = new THREE.Group();
            pivot.add(group);
            pivot.position.set(x, 0, z);
            pivot.lookAt(0, 0, 0);
            group.rotation.y = Math.PI;
            group.userData = { id: item.id, type: 'menu' };
            mainGroup.add(pivot);
        });

        // Bigger Plate for Builder
        const builderPlateGeo = new THREE.CylinderGeometry(6, 5.5, 0.2, 64);
        const builderPlateMat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.1 });
        const builderPlate = new THREE.Mesh(builderPlateGeo, builderPlateMat);
        builderGroup.add(builderPlate);
        
        // Raycaster
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        
        // Interaction State
        let isDragging3D = false;
        let isRotatingPlate = false;
        let draggedMesh = null;
        let dragGhost = document.getElementById('drag-ghost');
        let previousMouseX = 0;
        
        const dropZoneOverlay = document.getElementById('plate-drop-zone');
        
        dropZoneOverlay.addEventListener('mousedown', onMouseDown);
        dropZoneOverlay.addEventListener('mousemove', onMouseMove);
        dropZoneOverlay.addEventListener('mouseup', onMouseUp);
        dropZoneOverlay.addEventListener('touchstart', onTouchStart, {passive: false});
        dropZoneOverlay.addEventListener('touchmove', onTouchMove, {passive: false});
        dropZoneOverlay.addEventListener('touchend', onTouchEnd);
        
        function onMouseDown(e) { handleInputStart(e.clientX, e.clientY); }
        function onTouchStart(e) { handleInputStart(e.touches[0].clientX, e.touches[0].clientY); }

        function handleInputStart(x, y) {
            if(app.state.view !== 'builder') return;
            
            mouse.x = (x / window.innerWidth) * 2 - 1;
            mouse.y = -(y / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            
            const builderFoods = builderGroup.children.filter(c => c !== builderPlate && c !== particleSystem);
            const intersects = raycaster.intersectObjects(builderFoods, false);
            
            if(intersects.length > 0) {
                // Selection logic for showing info
                const item = plateBuilderState.items.find(i => i.mesh === intersects[0].object);
                if(item) showSelectedInfo(item);

                // Drag logic
                isDragging3D = true;
                draggedMesh = intersects[0].object;
                dragGhost.style.display = 'block';
                if(draggedMesh.material && draggedMesh.material.map && draggedMesh.material.map.image) {
                    dragGhost.style.backgroundImage = `url(${draggedMesh.material.map.image.src})`;
                } else {
                    dragGhost.style.backgroundColor = '#ccc';
                }
                updateGhost(x, y);
                draggedMesh.visible = false;
            } else {
                // Hit nothing or base plate -> Rotate Mode
                isRotatingPlate = true;
                previousMouseX = x;
                // Hide info card if clicking empty space
                document.getElementById('selected-item-card').classList.add('hidden');
            }
        }
        
        function showSelectedInfo(builderItem) {
            const card = document.getElementById('selected-item-card');
            document.getElementById('sel-name').innerText = builderItem.name;
            document.getElementById('sel-cal').innerText = builderItem.selectedPortion.cal;
            // Mock protein calc based on cal
            document.getElementById('sel-prot').innerText = Math.floor(builderItem.selectedPortion.cal / 10) + "g";
            card.classList.remove('hidden');
        }

        function onMouseMove(e) { handleInputMove(e.clientX, e.clientY); }
        function onTouchMove(e) { handleInputMove(e.touches[0].clientX, e.touches[0].clientY); }

        function handleInputMove(x, y) {
            if(isDragging3D) {
                updateGhost(x, y);
            } else if(isRotatingPlate) {
                const delta = x - previousMouseX;
                builderGroup.rotation.y += delta * 0.01;
                previousMouseX = x;
            }
        }
        
        function onMouseUp(e) { handleInputEnd(e.clientX, e.clientY); }
        function onTouchEnd(e) { handleInputEnd(e.changedTouches[0].clientX, e.changedTouches[0].clientY); }

        function handleInputEnd(x, y) {
            if(isDragging3D) {
                isDragging3D = false;
                dragGhost.style.display = 'none';
                
                const bin = document.getElementById('trash-bin');
                if(bin) {
                    const rect = bin.getBoundingClientRect();
                    if(x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                        // Remove mesh
                        builderGroup.remove(draggedMesh);
                        
                        // Remove item logic
                        const itemIndex = plateBuilderState.items.findIndex(i => i.mesh === draggedMesh);
                        if(itemIndex > -1) {
                             plateBuilderState.items.splice(itemIndex, 1);
                             app.updateBuilderTotals();
                             app.renderBuilderSidebar(app.state.currentBuilderFilter === 'all' ? menuItems : menuItems.filter(i => i.type === app.state.currentBuilderFilter)); // Re-render sidebar with items
                        }
                        
                        draggedMesh = null;
                        return;
                    }
                }
                // Return to plate if not bin
                if(draggedMesh) draggedMesh.visible = true;
                draggedMesh = null;
            }
            isRotatingPlate = false;
        }
        
        function updateGhost(x, y) {
            dragGhost.style.left = x + 'px';
            dragGhost.style.top = y + 'px';
        }

        window.addEventListener('click', onRaycast);
        function onRaycast(e) {
            if(e.target.tagName !== 'CANVAS' || isDragging3D || isRotatingPlate) return;
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            if(app.state.view === 'menu' || app.state.view === 'home') {
                const intersects = raycaster.intersectObjects(mainGroup.children, true);
                if(intersects.length > 0) {
                    let obj = intersects[0].object;
                    while(obj.parent && !obj.userData.id) obj = obj.parent;
                    if(obj.userData.id) app.openPortionModal(obj.userData.id);
                }
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            if(app.state.view === 'home' || app.state.view === 'menu') {
                mainGroup.rotation.y -= 0.001;
            }
            if(app.state.view === 'builder') {
                if(particleSystem.material.opacity > 0) {
                    const positions = particleSystem.geometry.attributes.position.array;
                    for(let i=0; i<particleCount; i++) {
                        positions[i*3+1] += pVelocities[i].y; 
                        positions[i*3] += pVelocities[i].x;   
                        positions[i*3+2] += pVelocities[i].z; 
                        if(positions[i*3+1] > 3) {
                            positions[i*3+1] = 0.5;
                            positions[i*3] = (Math.random() - 0.5) * 4;
                            positions[i*3+2] = (Math.random() - 0.5) * 4;
                        }
                    }
                    particleSystem.geometry.attributes.position.needsUpdate = true;
                }
                // Update Labels positions
                plateBuilderState.items.forEach((item, idx) => {
                    if(item.mesh) {
                        const pos = item.mesh.position.clone();
                        pos.applyMatrix4(item.mesh.parent.matrixWorld); // Get world pos
                        pos.project(camera);
                        
                        const x = (pos.x * .5 + .5) * window.innerWidth;
                        const y = (-(pos.y * .5) + .5) * window.innerHeight;
                        let label = document.getElementById(`label-${idx}`);


                    }
                });
            } else {
                 // Hide labels if not in builder
                 document.getElementById('labels-container').innerHTML = '';
            }

            // Rotate eating group if visible (slow auto-rotate when not dragging)
            if(app.state.view === 'status' && !lastOrder && eatingGroup.visible) {
                 // Only auto-rotate if user is not dragging
                 if (typeof isDraggingDoll !== 'undefined' && !isDraggingDoll && typeof dollModel !== 'undefined' && dollModel) {
                     dollModel.rotation.y += 0.003; // Slow auto-rotation
                 }
            }

            controls.update();
            renderer.render(scene, camera);
        }
        
        setTimeout(() => { document.getElementById('loader').style.display = 'none'; animate(); }, 1000);

        // --- APP LOGIC ---
        const app = {
            state: { view: 'home', cartOpen: false, selectedRating: 0, feedbackSubmitted: false, orderEndTime: null, currentBuilderFilter: 'all' },

            switchView: function(view) {
                this.state.view = view;
                document.querySelectorAll('.hidden-section').forEach(el => { el.style.display = 'none'; el.style.opacity = '0'; });
                document.getElementById('view-home').style.display = 'none';
                
                gameManager.stopGames();

                if(view === 'home') {
                    document.getElementById('view-home').style.display = 'block';
                    mainGroup.visible = true; builderGroup.visible = false; eatingGroup.visible = false;
                    gsap.to(camera.position, {x:0, y:18, z:22, duration:1});
                } else if(view === 'menu') {
                    const el = document.getElementById('view-menu'); el.style.display = 'flex'; gsap.to(el, {opacity:1});
                    mainGroup.visible = true; builderGroup.visible = false; eatingGroup.visible = false;
                    gsap.to(camera.position, {x:0, y:25, z:10, duration:1});
                    this.renderMenuGrid(menuItems);
                } else if(view === 'builder') {
                    const el = document.getElementById('view-builder'); el.style.display = 'flex'; gsap.to(el, {opacity:1});
                    mainGroup.visible = false; builderGroup.visible = true; eatingGroup.visible = false;
                    this.clearPlate(); 
                    particleSystem.material.opacity = 0; 
                    gsap.to(camera.position, {x:0, y:20, z:15, duration:1});
                    this.renderBuilderSidebar(menuItems);
                } else if(view === 'admin') {
                    const el = document.getElementById('view-admin'); el.style.display = 'flex'; gsap.to(el, {opacity:1});
                    this.setAdminTab('dash');
                } else if(view === 'status') {
                    const el = document.getElementById('view-status'); el.style.display = 'flex'; gsap.to(el, {opacity:1});
                    
                    if(lastOrder) {
                        // Active Order
                        document.getElementById('status-active').style.display = 'flex';
                        document.getElementById('status-empty').style.display = 'none';
                        mainGroup.visible = true; eatingGroup.visible = false;
                        this.renderOrderDetails();
                        this.startOrderTimer();
                        // Auto-open feedback after 4 seconds
                        setTimeout(() => {
                            app.openFeedbackModal();
                        }, 4000);
                    } else {
                        // No Order
                        document.getElementById('status-active').style.display = 'none';
                        document.getElementById('status-empty').style.display = 'flex';
                        mainGroup.visible = false; builderGroup.visible = false; eatingGroup.visible = true;
                        
                        // Responsive camera distance for doll viewing
                        const camZ = typeof getDollCameraZ === 'function' ? getDollCameraZ() : 20;
                        gsap.to(camera.position, {x:0, y:3, z:camZ, duration:1});
                        gsap.to(controls.target, {x:0, y:0, z:0, duration:1});
                        
                        // Reset doll rotation when entering view
                        if (typeof dollModel !== 'undefined' && dollModel) {
                            dollModel.rotation.set(0, 0, 0);
                        }
                    }
                } else {
                    const el = document.getElementById('view-' + view); el.style.display = 'flex'; gsap.to(el, {opacity:1});
                }
            },

            trackOrder: function() {
                this.switchView('status');
            },

            filterMenu: function(type) {
                const filtered = type === 'all' ? menuItems : menuItems.filter(i => i.type === type);
                this.renderMenuGrid(filtered);
            },
            filterBuilder: function(type) {
                this.state.currentBuilderFilter = type;
                const filtered = type === 'all' ? menuItems : menuItems.filter(i => i.type === type);
                this.renderBuilderSidebar(filtered);
            },
            
            getPlateQuantity: function(itemId) {
                return plateBuilderState.items.filter(i => i.id === itemId).length;
            },

            renderBuilderSidebar: function(items) {
                if (!items || !items.map) return; // Guard against invalid data
                document.getElementById('builder-items').innerHTML = items.map(item => {
                    const qty = this.getPlateQuantity(item.id);
                    return `
                        <div class="draggable-item bg-black/40 p-3 rounded-lg border border-[#a1887f]/30 flex gap-3 items-center hover:bg-[#3e2723]/40 transition" draggable="true" ondragstart="app.dragStart(event, ${item.id})" onclick="app.addBuilderItem(${item.id}, 0)">
                            <img src="${item.img}" class="w-12 h-12 rounded object-cover pointer-events-none">
                            <div class="flex-1 pointer-events-none">
                                <div class="font-bold text-sm text-[#d7ccc8]">${item.name}</div>
                                <div class="text-[10px] text-gray-400">Drag to Add</div>
                            </div>
                            <!-- Quantity Control -->
                            <div class="flex items-center gap-2 bg-black/50 rounded-lg p-1">
                                <button onclick="app.updateBuilderItemQuantity(${item.id}, -1)" class="text-yellow-600 hover:text-yellow-400 px-2 py-1 font-bold" ${qty===0?'disabled style="opacity:0.5"':''}>-</button>
                                <span class="text-white font-bold w-6 text-center">${qty}</span>
                                <button onclick="app.updateBuilderItemQuantity(${item.id}, 1)" class="text-yellow-600 hover:text-yellow-400 px-2 py-1 font-bold">+</button>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            updateBuilderItemQuantity: function(itemId, change) {
                if (change === 1) {
                    this.addBuilderItem(itemId, 0);
                } else if (change === -1) {
                    const itemIndex = plateBuilderState.items.findLastIndex(i => i.id === itemId);
                    if (itemIndex > -1) {
                        const item = plateBuilderState.items[itemIndex];
                        builderGroup.remove(item.mesh);
                        plateBuilderState.items.splice(itemIndex, 1);
                        this.updateBuilderTotals();
                        
                        // Remove label if exists
                        const label = document.getElementById(`label-${itemIndex}`);
                        if(label) label.remove();
                        
                        // Re-filter based on current state to refresh sidebar
                        const currentItems = this.state.currentBuilderFilter === 'all' ? menuItems : menuItems.filter(i => i.type === this.state.currentBuilderFilter);
                        this.renderBuilderSidebar(currentItems);
                    }
                }
            },

            dragStart: function(ev, id) { ev.dataTransfer.setData("text/plain", id); ev.dataTransfer.effectAllowed = "copy"; },
            allowDrop: function(ev) { ev.preventDefault(); },
            handleDrop: function(ev) { ev.preventDefault(); const id = ev.dataTransfer.getData("text/plain"); if(id) this.addBuilderItem(parseInt(id), 0); },
            handleBinDrop: function(ev) { ev.preventDefault(); ev.target.classList.remove('bin-active'); },
            
            clearPlate: function() {
                plateBuilderState.items = [];
                const toRemove = builderGroup.children.filter(c => c !== builderPlate && c !== particleSystem);
                toRemove.forEach(c => builderGroup.remove(c));
                document.getElementById('labels-container').innerHTML = ''; // Clear labels
                this.updateBuilderTotals();
                particleSystem.material.opacity = 0;
                
                // Re-render sidebar to reset counts
                const currentItems = this.state.currentBuilderFilter === 'all' ? menuItems : menuItems.filter(i => i.type === this.state.currentBuilderFilter);
                this.renderBuilderSidebar(currentItems);
            },
            addBuilderItem: function(itemId, portionIdx) {
                const item = menuItems.find(i => i.id === itemId);
                const portion = item.portions[portionIdx];
                
                const foodGeo = new THREE.SphereGeometry(Math.random() * 0.5 + 0.5, 32, 32);
                const tex = imgLoader.load(item.img);
                const mat = new THREE.MeshStandardMaterial({ map: tex });
                const mesh = new THREE.Mesh(foodGeo, mat);
                mesh.position.set((Math.random()-0.5)*7, 5, (Math.random()-0.5)*7);
                builderGroup.add(mesh);
                gsap.to(mesh.position, { y: 0.5, duration: 0.5, ease: "bounce.out" });
                
                // Store mesh ref
                plateBuilderState.items.push({ ...item, selectedPortion: portion, mesh: mesh });
                
                particleSystem.material.opacity = 0.5;
                this.updateBuilderTotals();
                this.showEatingAnim();
                
                // Refresh sidebar for quantity update
                const currentItems = this.state.currentBuilderFilter === 'all' ? menuItems : menuItems.filter(i => i.type === this.state.currentBuilderFilter);
                this.renderBuilderSidebar(currentItems);
            },
            updateBuilderTotals: function() {
                const total = plateBuilderState.items.reduce((a,b) => a + b.selectedPortion.price, 0);
                const cal = plateBuilderState.items.reduce((a,b) => a + b.selectedPortion.cal, 0);
                document.getElementById('builder-total').innerText = total;
                document.getElementById('builder-cal').innerText = cal + " kcal";
            },
            addBuilderToCart: function() {
                if(plateBuilderState.items.length === 0) return alert("Plate is empty!");
                const total = plateBuilderState.items.reduce((a,b) => a + b.selectedPortion.price, 0);
                const cal = plateBuilderState.items.reduce((a,b) => a + b.selectedPortion.cal, 0);
                cart = SharedCart.addItem({ name: "Custom VR Plate", price: total, img: "https://images.unsplash.com/photo-1546069901-ba9599a7e63c?auto=format&fit=crop&w=100&q=80", desc: `${plateBuilderState.items.length} items (${cal} cal)` });
                this.clearPlate();
                this.updateCart(); this.switchView('home'); confetti({ particleCount: 50, spread: 60, origin: { y: 0.6 } });
            },

            showEatingAnim: function() {
                const txt = document.getElementById('eating-overlay');
                const word = wordList[Math.floor(Math.random() * wordList.length)];
                const el = txt.querySelector('.super-text');
                el.innerText = word; el.style.opacity = '1';
                gsap.fromTo('.super-text', {scale:0, rotation: -20}, {scale:1, rotation: 0, duration:0.4, ease: "back.out(2)", onComplete: () => { gsap.to('.super-text', {scale:1.5, opacity:0, duration:0.3, delay:0.5}); }});
            },

            openFeedbackModal: function(force = false) {
                // Check if paid for smart logic, unless forced by button
                if(this.state.feedbackSubmitted && !force) return; 
                
                document.getElementById('feedback-modal').classList.remove('hidden');
                document.getElementById('feedback-form').style.display = 'block';
                document.getElementById('feedback-success').style.display = 'none';
                
                // Hide User Details if Paid (Assumed already known)
                const userFields = document.getElementById('feedback-user-fields');
                if(hasPaid) {
                    userFields.style.display = 'none';
                } else {
                    userFields.style.display = 'block';
                }
                
                document.getElementById('fb-error').classList.add('hidden');
                this.handleStarClick(0);
            },
            handleStarClick: function(n) {
                this.state.selectedRating = n;
                const stars = document.querySelectorAll('.star-rating span');
                stars.forEach((star, index) => {
                    if (index < n) star.classList.add('active');
                    else star.classList.remove('active');
                });
            },
            submitFeedback: function() {
                // Validate only if not paid
                if(!hasPaid) {
                    const name = document.getElementById('fb-name').value;
                    const email = document.getElementById('fb-email').value;
                    if(!name || !email) return alert("Please fill in name and email");
                    
                    if(submittedEmails.has(email)) {
                        document.getElementById('fb-error').innerText = "You have already submitted feedback.";
                        document.getElementById('fb-error').classList.remove('hidden');
                        return;
                    }
                    submittedEmails.add(email);
                }
                
                this.state.feedbackSubmitted = true;
                document.getElementById('feedback-form').style.display = 'none';
                document.getElementById('feedback-success').style.display = 'block';
                setTimeout(() => { document.getElementById('feedback-modal').classList.add('hidden'); }, 2500);
            },

            setEntTab: function(tab) {
                document.getElementById('ent-content-games').style.display = tab === 'games' ? 'flex' : 'none';
            },

            setAdminTab: function(tab) {
                document.querySelectorAll('[id^="admin-tab-"]').forEach(el => el.classList.add('hidden'));
                document.getElementById('admin-tab-' + tab).classList.remove('hidden');
                if(tab === 'kds') this.renderAdminKDS();
            },
            renderAdminKDS: function() {
                const con = document.getElementById('admin-tab-kds');
                if(activeOrders.length === 0) return con.innerHTML = "<div class='text-gray-500'>No active tickets.</div>";
                con.innerHTML = activeOrders.map(o => `<div class="bg-[#1a0f0d] p-4 rounded border border-l-4 border-l-yellow-600 border-gray-800"><div class="flex justify-between font-bold text-[#d7ccc8]"><span>#${o.token}</span> <span>${o.time}</span></div><div class="text-xs text-gray-500 mt-2 mb-2">${o.items.length} items</div>${o.items.map(i => `<div class="text-sm text-gray-400 border-b border-gray-800 py-1">${i.name}</div>`).join('')}<div class="mt-3 text-yellow-500 text-xs font-mono animate-pulse">PREPARING</div></div>`).join('');
            },

            renderMenuGrid: function(items) {
                document.getElementById('menu-grid').innerHTML = items.map(item => `
                    <div class="menu-card bg-[#1a0f0d] p-4 rounded-xl border border-[#a1887f]/20 cursor-pointer" onclick="app.openPortionModal(${item.id})">
                        <img src="${item.img}" class="w-full h-32 object-cover rounded-lg mb-3">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-[#d7ccc8]">${item.name}</h4>
                            <span class="text-[10px] px-2 py-0.5 rounded ${item.type==='veg'?'bg-green-900 text-green-300':'bg-red-900 text-red-300'} uppercase">${item.type}</span>
                        </div>
                        <p class="text-xs text-gray-500 line-clamp-2">${item.desc}</p>
                        <div class="mt-2 text-yellow-600 font-bold text-sm">From ‚Çπ${item.portions[0].price}</div>
                    </div>
                `).join('');
            },
            openPortionModal: function(id) {
                const item = menuItems.find(i => i.id === id);
                document.getElementById('pm-title').innerText = item.name; 
                document.getElementById('pm-desc').innerText = item.desc;
                document.getElementById('pm-allergens').innerText = item.allergens.length > 0 ? item.allergens.join(", ") : "None";
                
                document.getElementById('pm-options').innerHTML = item.portions.map((p, i) => `<label class="flex justify-between items-center p-3 border border-[#3e2723] rounded-lg cursor-pointer hover:bg-[#2c1b18]"><div class="flex items-center gap-3"><input type="radio" name="portion" value="${i}" ${i===0?'checked':''} onchange="app.updatePMPrice(${id}, ${i})" class="accent-yellow-600"><div><div class="text-sm font-bold text-gray-300">${p.label}</div><div class="text-xs text-gray-500">${p.cal} Cal</div></div></div><div class="text-[#d7ccc8]">‚Çπ${p.price}</div></label>`).join('');
                this.updatePMPrice(id, 0); document.getElementById('portion-modal').classList.remove('hidden');
            },
            updatePMPrice: function(id, idx) {
                const item = menuItems.find(i => i.id === id);
                const portion = item.portions[idx];
                document.getElementById('pm-total').innerText = portion.price;
                document.getElementById('pm-add-btn').onclick = () => {
                    this.addToCart({ ...item, name: `${item.name} (${portion.label})`, price: portion.price });
                    document.getElementById('portion-modal').classList.add('hidden');
                };
            },
            addToCart: function(item) { cart = SharedCart.addItem(item); this.updateCart(); this.showEatingAnim(); },
            updateCart: function() {
                document.getElementById('cart-count').innerText = cart.length;
                document.getElementById('cart-items').innerHTML = cart.map((item, i) => `<div class="flex justify-between items-center bg-[#1a0f0d] p-3 rounded border border-[#3e2723]"><div><div class="text-sm text-gray-300">${item.name}</div><div class="text-xs text-yellow-600">‚Çπ${item.price}</div></div><button onclick="app.remCart(${i})" class="text-red-900 hover:text-red-500 px-2">&times;</button></div>`).join('');
                const total = cart.reduce((a, b) => a + parseFloat(b.price), 0); const tax = total * 0.05;
                document.getElementById('cart-subtotal').innerText = total.toFixed(2); document.getElementById('cart-tax').innerText = tax.toFixed(2); document.getElementById('cart-total').innerText = (total + tax).toFixed(2);
            },
            remCart: function(i) { cart = SharedCart.removeItem(i); this.updateCart(); },
            toggleCart: function() { document.getElementById('cart-sidebar').classList.toggle('translate-x-full'); },
            openPaymentModal: function() { if(cart.length === 0) return; document.getElementById('pay-step-details').style.display = 'block'; document.getElementById('pay-step-1').style.display = 'none'; document.getElementById('pay-step-upi').style.display = 'none'; document.getElementById('pay-step-card').style.display = 'none'; document.getElementById('payment-modal').classList.remove('hidden'); },
            submitDetails: function() {
                const name = document.getElementById('user-name').value;
                const phone = document.getElementById('user-phone').value;
                const email = document.getElementById('user-email').value; // Optional
                if(!name || !phone) return alert("Please fill in your details.");
                // BACKEND: Store User Details
                this.showPaymentStep('1');
            },
            showPaymentStep: function(step) {
                document.getElementById('pay-step-details').style.display = 'none';
                document.getElementById('pay-step-1').style.display = 'none'; document.getElementById('pay-step-upi').style.display = 'none'; document.getElementById('pay-step-card').style.display = 'none';
                if(step === 'details') document.getElementById('pay-step-details').style.display = 'block';
                if(step === '1') document.getElementById('pay-step-1').style.display = 'block';
                if(step === 'upi') document.getElementById('pay-step-upi').style.display = 'block';
                if(step === 'card') document.getElementById('pay-step-card').style.display = 'block';
            },
            closePaymentModal: function() { document.getElementById('payment-modal').classList.add('hidden'); },
            
            processPayment: function() {
                this.closePaymentModal();
                this.toggleCart();
                hasPaid = true;

                // Generate Order Token  
                const token = Math.floor(1000 + Math.random() * 9000);
                const orderTime = 30; // 30 seconds for demo (can change to 15 minutes = 900)

                // Create Order Object  
                lastOrder = {
                    token,
                    items: [...cart],
                    status: "pending",
                    startTime: Date.now(),
                    totalTime: orderTime * 1000
                };

                activeOrders.push(lastOrder);
                
                // Set timer end time
                this.state.orderEndTime = Date.now() + (orderTime * 1000);

                // Add to KDS ‚Üí Pending  
                this.addToKitchenPending(lastOrder);

                // Show token popup  
                document.getElementById("token-display").innerText = `#${token}`;
                document.getElementById("status-token").innerText = token;
                document.getElementById("token-modal").classList.remove("hidden");
                
                // Clear cart  
                cart = SharedCart.clearCart();
                this.updateCart();
                
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });

                // ========== KITCHEN FLOW: Pending ‚Üí Cooking ‚Üí Ready ==========
                const pendingTime = Math.floor(orderTime * 0.3) * 1000; // 30% pending
                const cookingTime = Math.floor(orderTime * 0.5) * 1000; // 50% cooking
                
                // Move to COOKING after pendingTime
                setTimeout(() => {
                    this.moveToKitchenCooking(token);
                }, pendingTime);
                
                // Move to READY after pendingTime + cookingTime
                setTimeout(() => {
                    this.moveToKitchenReady(token);
                }, pendingTime + cookingTime);
            },
            
            addToKitchenPending: function(order) {
                const container = document.getElementById("kds-pending");
                const card = document.createElement("div");
                card.className = "kds-card pending animate-pop";
                card.id = `kds-order-${order.token}`;
                card.innerHTML = `
                    <h3 class="text-lg font-bold text-red-400">Order #${order.token}</h3>
                    <ul class="text-sm text-gray-300 mb-2">
                        ${order.items.map(i => `<li>‚Ä¢ ${i.name}</li>`).join("")}
                    </ul>
                    <div class="text-xs text-red-400 mt-2 font-mono">‚è≥ PENDING...</div>
                `;
                container.appendChild(card);
                
                // Update lastOrder status
                const orderObj = activeOrders.find(o => o.token === order.token);
                if (orderObj) orderObj.status = "pending";
            },
            
            moveToKitchenCooking: function(token) {
                const card = document.getElementById(`kds-order-${token}`);
                if (!card) return;
                
                // Update card styling
                card.classList.remove("pending");
                card.classList.add("animate-pop");
                card.style.borderLeftColor = "#eab308";
                card.querySelector("h3").className = "text-lg font-bold text-yellow-400";
                card.querySelector("div:last-child").innerHTML = "üî• COOKING...";
                card.querySelector("div:last-child").className = "text-xs text-yellow-400 mt-2 font-mono animate-pulse";
                
                // Move to cooking column
                document.getElementById("kds-cooking").appendChild(card);
                
                // Update order status
                const order = activeOrders.find(o => o.token === token);
                if (order) order.status = "cooking";
                if (lastOrder && lastOrder.token === token) lastOrder.status = "cooking";
                
                // Play cooking sound
                const ding = document.getElementById("kitchen-ding");
                if (ding) ding.play().catch(()=>{});
            },
            
            moveToKitchenReady: function(token) {
                const card = document.getElementById(`kds-order-${token}`);
                if (!card) return;
                
                // Update card styling
                card.classList.add("ready");
                card.style.borderLeftColor = "#22c55e";
                card.querySelector("h3").className = "text-lg font-bold text-green-400";
                card.querySelector("div:last-child").innerHTML = "‚úÖ READY FOR PICKUP!";
                card.querySelector("div:last-child").className = "text-xs text-green-400 mt-2 font-mono font-bold";
                
                // Move to ready column
                document.getElementById("kds-ready").appendChild(card);
                
                // Update order status
                const order = activeOrders.find(o => o.token === token);
                if (order) order.status = "ready";
                if (lastOrder && lastOrder.token === token) lastOrder.status = "ready";
                
                // Play notification sounds - "tiring tiring"
                this.playReadyNotification();
                
                // Show ready popup
                const readyPopup = document.getElementById("ready-popup");
                const readyToken = document.getElementById("ready-token");
                if (readyPopup && readyToken) {
                    readyToken.innerText = `#${token}`;
                    readyPopup.classList.remove("hidden");
                }
                
                // Show toast notification
                this.showToast(`Order #${token} is READY! üçΩÔ∏è`);
            },
            
            playReadyNotification: function() {
                // Play multiple beeps for "tiring tiring" effect
                const playBeep = (delay) => {
                    setTimeout(() => {
                        const sound = document.getElementById("notification-bell");
                        if (sound) {
                            sound.currentTime = 0;
                            sound.play().catch(()=>{});
                        }
                    }, delay);
                };
                
                // Play 3 beeps with intervals
                playBeep(0);
                playBeep(400);
                playBeep(800);
            },
            
            showToast: function(message) {
                const toast = document.getElementById('notification-toast');
                const msg = document.getElementById('toast-msg');
                if (toast && msg) {
                    msg.innerText = message;
                    toast.classList.remove('hidden');
                    toast.style.transform = 'translateX(-50%) translateY(0)';
                    setTimeout(() => {
                        toast.style.transform = 'translateX(-50%) translateY(-100px)';
                        setTimeout(() => toast.classList.add('hidden'), 500);
                    }, 4000);
                }
            },

            closeSuccess: function() { document.getElementById('token-modal').classList.add('hidden'); },
            goToStatus: function() { this.closeSuccess(); this.switchView('status'); },
            renderOrderDetails: function() {
                const list = document.getElementById('order-details-list');
                if(!lastOrder) return list.innerHTML = '<p class="text-gray-500">No active order</p>';
                list.innerHTML = lastOrder.items.map(i => `
                    <div class="flex justify-between text-xs py-2 border-b border-white/5">
                        <span class="text-gray-300">${i.name}</span>
                        <span class="text-yellow-600 font-bold">‚Çπ${i.price}</span>
                    </div>
                `).join('');
            },
            startOrderTimer: function() {
                if(orderTimerInterval) clearInterval(orderTimerInterval);
                
                // Use Persistent Time
                if (!this.state.orderEndTime) return;

                const updateTimer = () => {
                    const now = Date.now();
                    let diff = Math.floor((this.state.orderEndTime - now) / 1000);
                    
                    if (diff <= 0) {
                        diff = 0;
                        document.getElementById('order-timer').innerText = "READY";
                        clearInterval(orderTimerInterval);
                        return;
                    }

                    const mins = Math.floor(diff / 60).toString().padStart(2, '0');
                    const secs = (diff % 60).toString().padStart(2, '0');
                    document.getElementById('order-timer').innerText = `${mins}:${secs}`;
                };

                updateTimer(); // Run immediately
                orderTimerInterval = setInterval(updateTimer, 1000);
            }
        };
        
        SharedCart.init((updatedCart) => {
            cart = updatedCart;
            app.updateCart();
        });

        // --- GAME MANAGER ---
        const gameManager = {
            stage: document.getElementById('game-stage'),
            interval: null,
            timer: null,
            time: 120, // 2 minutes
            score: 0,
            stopGames: function() { 
                if(this.interval) clearInterval(this.interval);
                if(this.timer) clearInterval(this.timer);
                this.time = 120; this.score = 0;
                document.getElementById('game-over').classList.remove('visible');
                this.updateDisplay();
                this.stage.innerHTML = '<div class="text-center animate-pulse"><p class="text-[#5d4037] font-mono text-sm">SELECT A GAME TO START</p></div><div id="game-over" class="game-over-overlay"><h2 class="text-5xl font-comic text-red-500 mb-4">GAME OVER</h2><p class="text-xl mb-6">Score: <span id="final-score" class="text-yellow-500">0</span></p><button onclick="gameManager.stopGames()" class="bg-white text-black px-6 py-2 rounded-full font-bold hover:bg-gray-200">EXIT</button></div>'; 
            },
            startTimer: function() {
                this.timer = setInterval(() => {
                    this.time--;
                    const mins = Math.floor(this.time / 60).toString().padStart(2, '0');
                    const secs = (this.time % 60).toString().padStart(2, '0');
                    document.getElementById('game-time').innerText = `${mins}:${secs}`;
                    if(this.time <= 0) this.triggerGameOver();
                }, 1000);
            },
            triggerGameOver: function() {
                clearInterval(this.interval);
                clearInterval(this.timer);
                document.getElementById('final-score').innerText = this.score;
                document.getElementById('game-over').classList.add('visible');
            },
            addScore: function(points) {
                this.score += points;
                document.getElementById('game-score').innerText = this.score;
            },
            updateDisplay: function() {
                document.getElementById('game-score').innerText = this.score;
                document.getElementById('game-time').innerText = "02:00";
            },
            loadGame: function(type) {
                this.stopGames();
                this.startTimer();
                if(type === 'catch') this.initCatch();
                else if(type === 'memory') this.initMemory();
                else if(type === 'sudoku') this.initSudoku();
                else if(type === 'whack') this.initWhack();
            },
            
            initCatch: function() {
                this.stage.insertAdjacentHTML('afterbegin', '<div class="relative w-full h-full overflow-hidden bg-blue-900/20"><div id="basket" class="absolute bottom-2 w-20 h-10 bg-yellow-600 rounded flex justify-center items-center text-xl z-10 border-2 border-yellow-400">üóëÔ∏è</div></div>');
                let bx=150, nextSpawn=0;
                const basket = document.getElementById('basket');
                const foods = [];
                
                this.stage.onmousemove = e => { const rect = this.stage.getBoundingClientRect(); bx = e.clientX - rect.left - 40; if(bx<0)bx=0; if(bx>rect.width-80)bx=rect.width-80; basket.style.left = bx+'px'; };
                
                this.interval = setInterval(() => {
                    nextSpawn++;
                    if(nextSpawn > 20) {
                        nextSpawn = 0;
                        const f = document.createElement('div');
                        f.innerText = ['üçî','üçï','üåÆ','ü•ó'][Math.floor(Math.random()*4)];
                        f.className = 'absolute text-3xl';
                        f.style.left = Math.random() * (this.stage.offsetWidth - 40) + 'px';
                        f.style.top = '0px';
                        f.dataset.y = 0;
                        this.stage.appendChild(f);
                        foods.push(f);
                    }
                    
                    for(let i=foods.length-1; i>=0; i--) {
                        let f = foods[i];
                        let y = parseFloat(f.dataset.y) + 5;
                        f.dataset.y = y;
                        f.style.top = y + 'px';
                        
                        const fRect = f.getBoundingClientRect();
                        const bRect = basket.getBoundingClientRect();
                        
                        if(y > this.stage.offsetHeight - 60 && y < this.stage.offsetHeight) {
                            if(fRect.left < bRect.right && fRect.right > bRect.left) {
                                this.addScore(5);
                                f.remove();
                                foods.splice(i, 1);
                                continue;
                            }
                        }
                        if(y > this.stage.offsetHeight) {
                            f.remove();
                            foods.splice(i, 1);
                        }
                    }
                }, 30);
            },

            initMemory: function() {
                const emojis = ['üçï','üçï','üçî','üçî','üçü','üçü','ü•ó','ü•ó','üçó','üçó','ü•®','ü•®','ü•ì','ü•ì','ü•ë','ü•ë','ü••','ü••','ü•ö','ü•ö'];
                emojis.sort(() => Math.random() - 0.5);
                this.stage.insertAdjacentHTML('afterbegin', `<div class="memory-grid">${emojis.map((e,i)=>`<div class="memory-card" onclick="gameManager.flip(${i}, '${e}')"><div class="memory-inner" id="card-${i}"><div class="memory-front">?</div><div class="memory-back">${e}</div></div></div>`).join('')}</div>`);
                this.flipped = []; this.matched = [];
            },
            flip: function(i, val) {
                if(this.flipped.length < 2 && !this.flipped.includes(i) && !this.matched.includes(i)) {
                    document.getElementById(`card-${i}`).parentElement.classList.add('flipped');
                    this.flipped.push({i, val});
                    if(this.flipped.length === 2) setTimeout(() => this.checkMatch(), 800);
                }
            },
            checkMatch: function() {
                const [c1, c2] = this.flipped;
                if(c1.val === c2.val) { this.matched.push(c1.i, c2.i); this.addScore(20); }
                else { 
                    document.getElementById(`card-${c1.i}`).parentElement.classList.remove('flipped');
                    document.getElementById(`card-${c2.i}`).parentElement.classList.remove('flipped');
                }
                this.flipped = [];
                if(this.matched.length === 20) this.triggerGameOver();
            },

            initSudoku: function() {
                const board = [[5,3,0,0,7,0,0,0,0], [6,0,0,1,9,5,0,0,0], [0,9,8,0,0,0,0,6,0], [8,0,0,0,6,0,0,0,3], [4,0,0,8,0,3,0,0,1], [7,0,0,0,2,0,0,0,6], [0,6,0,0,0,0,2,8,0], [0,0,0,4,1,9,0,0,5], [0,0,0,0,8,0,0,7,9]];
                let html = '<div class="grid grid-cols-9 gap-0 border-2 border-[#5d4037] w-64 h-64 mx-auto mt-4">';
                board.flat().forEach((n,i) => {
                    html += `<input type="text" class="sudoku-cell" maxlength="1" value="${n||''}" ${n?'disabled style="background:#2c1b18"':''} onchange="gameManager.addScore(5)">`;
                });
                html += '</div>';
                this.stage.insertAdjacentHTML('afterbegin', html);
            },

            initWhack: function() {
                this.stage.insertAdjacentHTML('afterbegin', '<div class="grid grid-cols-3 gap-2 p-4 h-64 w-64 mx-auto" id="whack-grid"></div>');
                const grid = document.getElementById('whack-grid');
                for(let i=0; i<9; i++) {
                    const hole = document.createElement('div');
                    hole.className = 'whack-hole';
                    const mole = document.createElement('div');
                    mole.className = 'whack-mole';
                    mole.innerText = 'ü•î';
                    mole.onclick = (e) => { 
                        if(mole.classList.contains('up')){ 
                            this.addScore(10); 
                            mole.classList.remove('up');
                            // Visual feedback
                            const bang = document.createElement('div');
                            bang.className = 'absolute inset-0 flex justify-center items-center text-4xl font-comic text-yellow-500 bonk-anim';
                            bang.innerText = 'BONK!';
                            hole.appendChild(bang);
                            setTimeout(()=>bang.remove(), 200);
                        }
                    };
                    hole.appendChild(mole);
                    grid.appendChild(hole);
                }
                this.interval = setInterval(() => {
                    const moles = document.querySelectorAll('.whack-mole');
                    moles.forEach(m => m.classList.remove('up'));
                    const rand = Math.floor(Math.random()*9);
                    moles[rand].classList.add('up');
                }, 800);
            }
        };

        app.renderMenuGrid(menuItems);
        app.updateCart(); // Initialize cart display on page load
        // app.renderBuilderSidebar(menuItems); // Called on switchView now
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
/* -------------------------------
    üî• KDS LIVE ORDER ENGINE
---------------------------------*/
let kdsOrderId = 1;
const kds = {
    createCard(order) {
        const div = document.createElement("div");
        div.className = "kds-card pending animate-pop";

        div.innerHTML = `
            <div class="font-bold text-lg">Order #${order.id}</div>
            <div class="text-sm text-gray-300">${order.item}</div>
            <div class="text-xs text-yellow-400 mt-1">‚è≥ ${order.time} mins</div>
        `;

        return div;
    },

    addToPending(order) {
        const card = this.createCard(order);
        document.getElementById("kds-pending").appendChild(card);

        // Move to COOKING
        setTimeout(() => this.moveToCooking(card, order), 3000);
    },

    moveToCooking(card, order) {
        card.classList.remove("pending");
        card.classList.add("animate-pop");
        card.style.borderLeftColor = "#eab308";
        card.querySelector("div:nth-child(3)").innerHTML = "üî• Cooking...";

        document.getElementById("kds-cooking").appendChild(card);

        // Move to READY
        setTimeout(() => this.moveToReady(card, order), 5000);
    },

    moveToReady(card, order) {
        card.classList.remove("pending");
        card.classList.add("ready");
        card.style.borderLeftColor = "#22c55e";
        card.querySelector("div:nth-child(3)").innerHTML = "‚úÖ Ready";

        document.getElementById("kds-ready").appendChild(card);

        // Auto remove after 10 seconds
        setTimeout(() => card.remove(), 10000);
    }
    
};


/* -----------------------------------------------------
    üî• WHEN USER PLACES ORDER ‚Üí SEND TO KITCHEN
-------------------------------------------------------*/
function sendOrderToKitchen(name = "Food Item") {
    const order = {
        id: kdsOrderId++,
        item: name,
        time: 15
    };

    kds.addToPending(order);
}


/* -----------------------------------------------------
   üî• AUTO RANDOM ORDERS - DISABLED (For real usage)
   Uncomment below for demo mode
------------------------------------------------------*/
// setInterval(() => {
//     const sample = ["Burger", "Biryani", "Pizza", "Fries", "Coffee", "Pasta", "Samosa"];
//     const r = sample[Math.floor(Math.random() * sample.length)];
//     sendOrderToKitchen(r);
// }, 10000);

// üî• PATCH 3 ‚Äî AUTO UPDATE USER TRACK ORDER VIEW
app.autoUpdateUserOrder = function() {
    if (!lastOrder) return;
let order = activeOrders.find(o => o.token === lastOrder.token);
if (!order) return;

document.getElementById("status-token").innerText = order.token;


    let listEl = document.getElementById("order-details-list");
    listEl.innerHTML = "";
    order.items.forEach(item => {
        let d = document.createElement("div");
        d.className = "text-gray-300 flex justify-between";
        d.innerHTML = `<span>${item.name}</span><span>‚Çπ${item.price}</span>`;
        listEl.appendChild(d);
    });

    

    // If READY ‚Üí show real-time notification
    if (order.status === "ready") {
        app.showToast("Your order is READY! üçΩÔ∏è");
        clearInterval(app.userOrderInterval);
    }
};

// Run auto-updater every 2 seconds
app.userOrderInterval = setInterval(app.autoUpdateUserOrder, 2000);

// Refresh cart when page gets focus (returning from c3.html)
window.addEventListener('focus', function() {
    cart = SharedCart.getCart();
    app.updateCart();
});

// Also listen for storage changes from other tabs
SharedCart.onCartChange(function(newCart) {
    cart = newCart;
    app.updateCart();
});

    </script>
    
    <!-- Order Ready Popup -->
    <div id="ready-popup" class="fixed inset-0 bg-black/90 z-[80] hidden flex items-center justify-center interactive backdrop-blur-xl">
        <div class="bg-gradient-to-b from-green-900 to-[#1a0f0d] border-2 border-green-500 w-full max-w-md rounded-3xl p-8 text-center animate-pop shadow-[0_0_60px_rgba(34,197,94,0.4)]">
            <div class="text-6xl mb-4 animate-bounce">üçΩÔ∏è</div>
            <h2 class="text-3xl font-heading text-green-400 mb-2">Order Ready!</h2>
            <p class="text-gray-300 mb-4">Your delicious meal is waiting for pickup!</p>
            <div class="bg-black/50 border border-green-500/50 rounded-2xl p-6 mb-6">
                <p class="text-[10px] text-green-400 uppercase tracking-[0.2em] mb-2">Token Number</p>
                <p id="ready-token" class="text-5xl font-mono font-bold text-green-400 tracking-widest">#0000</p>
            </div>
            <button onclick="document.getElementById('ready-popup').classList.add('hidden')" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl touch-btn transition">GOT IT!</button>
        </div>
    </div>
    
    <!-- Kitchen Sound Alerts - Multiple notification sounds -->
    <audio id="kitchen-ding" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
    <audio id="order-ready-sound" preload="auto">
        <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
    </audio>
    <audio id="notification-bell" preload="auto">
        <source src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg" type="audio/ogg">
    </audio>

</body>
</html>